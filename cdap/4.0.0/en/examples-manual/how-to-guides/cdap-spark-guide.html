<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KWLFGH');</script>
    <!-- End Google Tag Manager -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Cask Data, Inc." name="author" />
<meta content="Copyright Â© 2014-2016 Cask Data, Inc." name="copyright" />

    
    
    <meta name="git_release" content="4.0.0">
    <meta name="git_hash" content="0c15d1656b6063df42a5fcb2eea7c1bf80b1cb9b">
    <meta name="git_timestamp" content="2016-12-22 16:57:33 -0800">
    <title>Iterative Data Processing with Apache Spark &mdash; Cask Data Application Platform 4.0.0 Documentation</title>

    <link rel="canonical" href="http://docs.cask.co/cdap/4.0.0/en/examples-manual/how-to-guides/cdap-spark-guide.html">

    
    <link rel="stylesheet" href="../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/annotator.min.css" type="text/css" />



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/copy-to-clipboard.js"></script>
    <script type="text/javascript" src="../_static/tabbed-parsed-literal.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 4.0.0 Documentation" href="../index.html" />
    <link rel="up" title="How-To Guides" href="index.html" />
    <link rel="next" title="Storing Timeseries Data" href="cdap-timeseries-guide.html" />
    <link rel="prev" title="Batch Data Processing with CDAP" href="cdap-mapreduce-guide.html" /> 
  </head>
  <body role="document">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KWLFGH"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="cdap-timeseries-guide.html" title="Storing Timeseries Data"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="cdap-mapreduce-guide.html" title="Batch Data Processing with CDAP"
             accesskey="P">Previous</a> |</li>
        
        <script type="text/javascript" src="../_static/version-menu.js"></script>
        <script src="http://docs.cask.co/cdap/json-versions.js"/></script>
        <script>window.setVersion('4.0.0');</script>
       
        <li><a href="../table-of-contents.html">Examples, Guides, and Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">How-To Guides</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div id="documentwrapper" class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="iterative-data-processing-with-apache-spark">
<span id="cdap-spark-guide"></span><h1><a class="headerlink" href="#iterative-data-processing-with-apache-spark" title="Perma-link to this heading">ðŸ”—</a>Iterative Data Processing with Apache Spark</h1>
<blockquote class="pull-quote">
<div><strong>Source Code Repository:</strong> Source code (and other resources) for this guide are available at the
<a class="reference external" href="https://github.com/cdap-guides/cdap-spark-guide/tree/release/cdap-4.0-compatible">CDAP Guides GitHub repository</a>.</div></blockquote>
<p><a class="reference external" href="https://spark.apache.org/">Apache Spark</a> is a very popular engine to
perform in-memory cluster computing for Apache Hadoop. In this guide,
you will learn how to run Apache Spark programs with CDAP.</p>
<div class="section" id="what-you-will-build">
<h2><a class="headerlink" href="#what-you-will-build" title="Perma-link to this heading">ðŸ”—</a>What You Will Build</h2>
<p>You will build a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/applications.html">CDAP application</a>
that exposes a RESTful API to take in web pagesâ€™ backlinks information and
serve out the <a class="reference external" href="http://en.wikipedia.org/wiki/PageRank">PageRank</a> for the
known web pages. You will:</p>
<ul class="simple">
<li>Use a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/streams.html">Stream</a>
as the source of backlinks data;</li>
<li>Build a CDAP
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/spark-jobs.html">Spark</a>
program that reads directly from the Stream and computes the PageRank of the web pages;</li>
<li>Use a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/datasets/index.html">Dataset</a>
to store the output of the Spark program; and</li>
<li>Build a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/services.html">Service</a>
to serve the PageRank computation results over HTTP.</li>
</ul>
</div>
<div class="section" id="what-you-will-need">
<h2><a class="headerlink" href="#what-you-will-need" title="Perma-link to this heading">ðŸ”—</a>What You Will Need</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 7 or 8</a></li>
<li><a class="reference external" href="http://maven.apache.org/">Apache Maven 3.1+</a></li>
<li><a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/getting-started/standalone/index.html">CDAP SDK</a></li>
</ul>
</div>
<div class="section" id="lets-build-it">
<h2><a class="headerlink" href="#lets-build-it" title="Perma-link to this heading">ðŸ”—</a>Letâ€™s Build It!</h2>
<p>The following sections will guide you through building an application from scratch. If you
are interested in deploying and running the application right away, you can clone its
source code from this GitHub repository. In that case, feel free to skip the next two
sections and jump right to the
<a class="reference external" href="#build-and-run-application">Build and Run Application</a> section.</p>
<div class="section" id="application-design">
<h3><a class="headerlink" href="#application-design" title="Perma-link to this heading">ðŸ”—</a>Application Design</h3>
<p>Backlinks data is sent to the <em>backlinkURLStream</em> over HTTP (e.g. by a web
crawler as it processes web pages). The PageRank for known pages is
computed periodically by a <em>PageRankProgram</em>. The program uses the
<em>backlinkURLStream</em> as an input and persists the results in the
<em>pageRanks</em> dataset.</p>
<p>The <em>PageRankService</em> then uses the <em>pageRanks</em> dataset to serve the
PageRank for a given URL over HTTP.</p>
<p>In this guide we assume that the backlinks data will be sent to a CDAP
application.</p>
<a class="reference internal image-reference" href="../_images/app-design6.png"><img alt="../_images/app-design6.png" class="align-center" src="../_images/app-design6.png" style="width: 8in;" /></a>
</div>
<div class="section" id="implementation">
<h3><a class="headerlink" href="#implementation" title="Perma-link to this heading">ðŸ”—</a>Implementation</h3>
<p>The first step is to construct the application structure. We will use a
standard Maven project structure for all of the source code files:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">./pom.xml</span>
<span class="go">./src/main/java/co/cask/cdap/guides/PageRankApp.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/PageRankSpark.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/PageRankHandler.java</span>
<span class="go">./src/main/scala/co/cask/cdap/guides/PageRankProgram.scala</span>
</pre></div>
</div>
<p>The application is identified by the <code class="docutils literal"><span class="pre">PageRankApp</span></code> class. This class
extends <a class="reference external" href="http://docs.cdap.io/cdap/current/en/reference-manual/javadocs/co/cask/cdap/api/app/AbstractApplication.html">AbstractApplication</a>,
and overrides the <code class="docutils literal"><span class="pre">configure()</span></code> method to define all of the application components:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageRankApp</span> <span class="kd">extends</span> <span class="n">AbstractApplication</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PAGE_RANK_RANKS_SERVICE</span> <span class="o">=</span> <span class="s">&quot;PageRankService&quot;</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PAGE_RANK_BACKLINK_STREAM</span> <span class="o">=</span> <span class="s">&quot;backlinkURLStream&quot;</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PAGE_RANK_RANKS_DATASET</span> <span class="o">=</span> <span class="s">&quot;pageRanks&quot;</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">addSpark</span><span class="o">(</span><span class="k">new</span> <span class="n">PageRankSpark</span><span class="o">());</span>
    <span class="n">addStream</span><span class="o">(</span><span class="k">new</span> <span class="n">Stream</span><span class="o">(</span><span class="n">PAGE_RANK_BACKLINK_STREAM</span><span class="o">));</span>
    <span class="n">addService</span><span class="o">(</span><span class="n">PAGE_RANK_RANKS_SERVICE</span><span class="o">,</span> <span class="k">new</span> <span class="n">PageRankHandler</span><span class="o">());</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">ObjectStores</span><span class="o">.</span><span class="na">createObjectStore</span><span class="o">(</span><span class="n">getConfigurer</span><span class="o">(),</span> <span class="n">PAGE_RANK_RANKS_DATASET</span><span class="o">,</span> <span class="n">Double</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnsupportedTypeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&quot;Will never happen: all classes above are supported&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>In this example, we use a Stream to supply backlinks data;
the Spark program that computes the PageRank of the web pages reads directly from the Stream.
<code class="docutils literal"><span class="pre">backlinkURLStream</span></code> receives backlinks information in the form of two URLs separated by whitespace:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">http://example.com/page1 http://example.com/page10</span>
</pre></div>
</div>
<p>Weâ€™ll use Scala to write the Spark program (for an example of using Java, refer to the <a class="reference external" href="http://docs.cask.co/cdap/current/en/examples-manual/examples/spark-page-rank.html">CDAP SparkPageRank
example</a>).
Youâ€™ll need to add <code class="docutils literal"><span class="pre">scala</span></code> and <code class="docutils literal"><span class="pre">maven-scala-plugin</span></code> as dependencies in
your Maven <a class="reference external" href="https://github.com/cdap-guides/cdap-spark-guide/blob/develop/pom.xml">pom.xml</a>.</p>
<p>The code below configures Spark in CDAP. This class extends
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/reference-manual/javadocs/co/cask/cdap/api/spark/AbstractSpark.html">AbstractSpark</a>
and overrides the <code class="docutils literal"><span class="pre">configure()</span></code> method to define all of the components. The
<code class="docutils literal"><span class="pre">setMainClassName</span></code> method sets the Spark Program class which CDAP will run:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageRankSpark</span> <span class="kd">extends</span> <span class="n">AbstractSpark</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">setName</span><span class="o">(</span><span class="n">PageRankSpark</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
    <span class="n">setDescription</span><span class="o">(</span><span class="s">&quot;Spark program to compute PageRank&quot;</span><span class="o">);</span>
    <span class="n">setMainClass</span><span class="o">(</span><span class="n">PageRankProgram</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">PageRankProgram</span></code> Spark program does the actual page rank
computation. This code is taken from the <a class="reference external" href="https://github.com/apache/spark/blob/master/examples/src/main/scala/org/apache/spark/examples/SparkPageRank.scala">Apache Spark's PageRank example</a>;
the Spark program stores the computed PageRank in an ObjectStore
Dataset where the key is the URL and the value is the computed PageRank:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">PageRankProgram</span> <span class="kd">extends</span> <span class="n">SparkMain</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">val</span> <span class="n">ITERATIONS_COUNT</span><span class="o">:</span> <span class="n">Int</span> <span class="o">=</span> <span class="mi">10</span>

  <span class="n">override</span> <span class="n">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">implicit</span> <span class="n">sec</span><span class="o">:</span> <span class="n">SparkExecutionContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">sc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SparkContext</span>
    <span class="n">val</span> <span class="n">lines</span><span class="o">:</span> <span class="n">RDD</span><span class="o">[</span><span class="n">String</span><span class="o">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">fromStream</span><span class="o">(</span><span class="s">&quot;backlinkURLStream&quot;</span><span class="o">)</span>
    <span class="n">val</span> <span class="n">links</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="na">map</span> <span class="o">{</span> <span class="n">s</span> <span class="o">=&gt;</span>
      <span class="n">val</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\\s+&quot;</span><span class="o">)</span>
      <span class="o">(</span><span class="n">parts</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">parts</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">}.</span><span class="na">distinct</span><span class="o">().</span><span class="na">groupByKey</span><span class="o">().</span><span class="na">cache</span><span class="o">()</span>

    <span class="n">var</span> <span class="n">ranks</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="na">mapValues</span><span class="o">(</span><span class="n">v</span> <span class="o">=&gt;</span> <span class="mf">1.0</span><span class="o">)</span>

    <span class="c1">// Calculate the PageRanks</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">ITERATIONS_COUNT</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">val</span> <span class="n">contribs</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">ranks</span><span class="o">).</span><span class="na">values</span><span class="o">.</span><span class="na">flatMap</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">urls</span><span class="o">,</span> <span class="n">rank</span><span class="o">)</span> <span class="o">=&gt;</span>
        <span class="n">val</span> <span class="n">size</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="na">size</span>
        <span class="n">urls</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">url</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">rank</span> <span class="o">/</span> <span class="n">size</span><span class="o">))</span>
      <span class="o">}</span>
      <span class="n">ranks</span> <span class="o">=</span> <span class="n">contribs</span><span class="o">.</span><span class="na">reduceByKey</span><span class="o">(</span><span class="n">_</span> <span class="o">+</span> <span class="n">_</span><span class="o">).</span><span class="na">mapValues</span><span class="o">(</span><span class="mf">0.15</span> <span class="o">+</span> <span class="mf">0.85</span> <span class="o">*</span> <span class="n">_</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">ranks</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">x</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">_1</span><span class="o">),</span> <span class="n">x</span><span class="o">.</span><span class="na">_2</span><span class="o">)).</span><span class="na">saveAsDataset</span><span class="o">(</span><span class="s">&quot;pageRanks&quot;</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To serve results out via HTTP, add a <code class="docutils literal"><span class="pre">PageRankHandler</span></code>, which
reads the PageRank for a given URL from the <code class="docutils literal"><span class="pre">pageRanks</span></code> dataset:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PageRankHandler</span> <span class="kd">extends</span> <span class="n">AbstractHttpServiceHandler</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Gson</span> <span class="n">GSON</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">URL_KEY</span> <span class="o">=</span> <span class="s">&quot;url&quot;</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PAGE_RANKS_RANK_HANDLER</span> <span class="o">=</span> <span class="s">&quot;pagerank&quot;</span><span class="o">;</span>

  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="n">PageRankApp</span><span class="o">.</span><span class="na">PAGE_RANK_RANKS_DATASET</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">ObjectStore</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">ranks</span><span class="o">;</span>

  <span class="nd">@Path</span><span class="o">(</span><span class="n">PAGE_RANKS_RANK_HANDLER</span><span class="o">)</span>
  <span class="nd">@POST</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getRank</span><span class="o">(</span><span class="n">HttpServiceRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServiceResponder</span> <span class="n">responder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">GSON</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContent</span><span class="o">()).</span><span class="na">toString</span><span class="o">(),</span>
                               <span class="n">JsonObject</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">URL_KEY</span><span class="o">).</span><span class="na">getAsString</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">url</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">responder</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_BAD_REQUEST</span><span class="o">,</span> <span class="s">&quot;The url must be specified with url as key in JSON.&quot;</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Get the rank from the ranks dataset</span>
    <span class="n">Double</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">ranks</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rank</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">responder</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_NO_CONTENT</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;No rank found of %s&quot;</span><span class="o">,</span> <span class="n">url</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">responder</span><span class="o">.</span><span class="na">sendString</span><span class="o">(</span><span class="n">rank</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="build-and-run-application">
<h2><a class="headerlink" href="#build-and-run-application" title="Perma-link to this heading">ðŸ”—</a>Build and Run Application</h2>
<p>The <code class="docutils literal"><span class="pre">PageRankApp</span></code> application can be built and packaged using the Apache Maven command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> mvn clean package
</pre></div>
</div>
<p>Note that the remaining commands assume that the <code class="docutils literal"><span class="pre">cdap-cli.sh</span></code> script is
available on your PATH. If this is not the case, please add it:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:&lt;CDAP home&gt;/bin
</pre></div>
</div>
<p>If you haven't already started a standalone CDAP installation, start it with the command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap.sh start
</pre></div>
</div>
<p>You can then deploy the application to a standalone CDAP installation:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh load artifact target/cdap-spark-guide-&lt;version&gt;.jar
<span class="gp">$</span> cdap-cli.sh create app PageRankApp cdap-spark-guide &lt;version&gt; user
</pre></div>
</div>
<p>Start the Service:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh start service PageRankApp.PageRankService
</pre></div>
</div>
<p>Send some Data to the Stream:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh send stream backlinkURLStream <span class="se">\&#39;</span>http://example.com/page1 http://example.com/page1<span class="se">\&#39;</span>
<span class="gp">$</span> cdap-cli.sh send stream backlinkURLStream <span class="se">\&#39;</span>http://example.com/page1 http://example.com/page10<span class="se">\&#39;</span>
<span class="gp">$</span> cdap-cli.sh send stream backlinkURLStream <span class="se">\&#39;</span>http://example.com/page10 http://example.com/page10<span class="se">\&#39;</span>
<span class="gp">$</span> cdap-cli.sh send stream backlinkURLStream <span class="se">\&#39;</span>http://example.com/page10 http://example.com/page100<span class="se">\&#39;</span>
<span class="gp">$</span> cdap-cli.sh send stream backlinkURLStream <span class="se">\&#39;</span>http://example.com/page100 http://example.com/page100<span class="se">\&#39;</span>
</pre></div>
</div>
<p>Run the Spark Program:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh start spark PageRankApp.PageRankSpark
</pre></div>
</div>
<p>The Spark Program can take time to complete. You can check the status
for completion using:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh get spark status PageRankApp.PageRankSpark
</pre></div>
</div>
<p>Query for the PageRank results:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh call service PageRankApp.PageRankService POST <span class="s1">&#39;pagerank&#39;</span> body <span class="s1">&#39;{&quot;url&quot;:&quot;http://example.com/page1&quot;}&#39;</span>
</pre></div>
</div>
<p>Example output:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">+====================================================================================+</span>
<span class="go">| status | headers                                  | body size | body               |</span>
<span class="go">+====================================================================================+</span>
<span class="go">| 200    | Content-Length : 18                      | 18        | 0.2610116705534049 |</span>
<span class="go">|        | Content-Type : text/plain; charset=utf-8 |           |                    |</span>
<span class="go">|        | Connection : keep-alive                  |           |                    |</span>
<span class="go">+====================================================================================+</span>
</pre></div>
</div>
<p>Congratulations! You have now learned how to incorporate Spark programs
into your CDAP applications. Please continue to experiment and extend
this sample application.</p>
</div>
<div class="section" id="share-and-discuss">
<h2><a class="headerlink" href="#share-and-discuss" title="Perma-link to this heading">ðŸ”—</a>Share and Discuss!</h2>
<p>Have a question? Discuss at the <a class="reference external" href="https://groups.google.com/forum/#!forum/cdap-user">CDAP User Mailing List</a>.</p>
</div>
<div class="section" id="license">
<h2><a class="headerlink" href="#license" title="Perma-link to this heading">ðŸ”—</a>License</h2>
<p>Copyright Â© 2014-2016 Cask Data, Inc.</p>
<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may
not use this file except in compliance with the License. You may obtain
a copy of the License at</p>
<p><a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

  <div role="note" aria-label="manuals links">
    <h3><a href="../table-of-contents/../../index.html" rel="nofollow">CDAP Documentation v4.0.0</a></h3>
    
    <ul class="this-page-menu">
      <li><div class=""></div><a href="../table-of-contents/../../introduction/index.html" rel="nofollow">Introduction to CDAP</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../developers-manual/index.html" rel="nofollow">Developersâ€™ Manual</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../admin-manual/index.html" rel="nofollow">Administration Manual</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../integrations/index.html" rel="nofollow">Integrations</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../examples-manual/index.html" rel="nofollow">Examples, Guides, and Tutorials</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/index.html" rel="nofollow">Reference Manual</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../faqs/index.html" rel="nofollow">FAQs</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/release-notes.html" rel="nofollow">Release Notes</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/glossary.html" rel="nofollow">Glossary</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../search.html" rel="nofollow">Search</a></li>
    </ul>
    <h3 class="cdap-extensions">CDAP Extensions</h3>
    
    <ul class="this-page-menu">
      <li><div class=""></div><a href="../table-of-contents/../../hydrator-manual/index.html" rel="nofollow">Cask Hydrator</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../tracker-manual/index.html" rel="nofollow">Cask Tracker</a></li>
    </ul>
  </div>
    
  <h3 class="pagenavtitle"><a href="../table-of-contents.html">Examples, Guides, and Tutorials:<br> Table&nbsp;of&nbsp;Contents</a></h3>
    <nav class="pagenav">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How-To Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cdap-bi-guide.html">Analyzing CDAP Data from BI Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-cube-guide.html">Data Analysis with OLAP Cube</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-etl-guide.html">Creating Hydrator Applications using CDAP System Artifacts</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-flow-guide.html">Real-Time Data Processing with a Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-flume-guide.html">Ingesting Data into CDAP using Apache Flume</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-kafka-ingest-guide.html">Consuming Data from Kafka</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-mapreduce-guide.html">Batch Data Processing with CDAP</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Iterative Data Processing with Apache Spark</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-you-will-build">What You Will Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-you-will-need">What You Will Need</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lets-build-it">Letâ€™s Build It!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-and-run-application">Build and Run Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#share-and-discuss">Share and Discuss!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cdap-timeseries-guide.html">Storing Timeseries Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-twitter-ingest-guide.html">Consuming Twitter Data in Real Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-workflow-guide.html">Batch Data Processing with CDAP using Workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apps-packs.html">Apps and Packs</a></li>
</ul>
 
    </nav>
  
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/cdap/4.0.0/cdap-docs-4.0.0-web.zip"
            rel="nofollow">Zip Archive of CDAP Documentation</a></li>
    </ul>
   </div>
<div role="note" aria-label="other links">
    <h3><a href="http://docs.cask.co/" target="_blank">Documentation</a></h3>
    <ul class="this-page-menu">
        <li><a href="http://docs.cask.co/cdap/index.html" target="_blank">CDAP</a></li>
        <li><a href="http://docs.cask.co/coopr/index.html" target="_blank">Coopr</a></li>
        <li><a href="http://docs.cask.co/tigon/index.html" target="_blank">Tigon</a></li>
    </ul>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>

  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Batch Data Processing with CDAP" href="cdap-mapreduce-guide.html" />Batch Data Processing with CDAP</a>&nbsp;&nbsp;
    </th>
    
    <th class="tg-s6z2">
        Copyright &copy; 2014-2016 Cask Data, Inc.
      &bull; Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="Storing Timeseries Data" href="cdap-timeseries-guide.html" />Storing Timeseries Data</a>
    </th>

  </tr>
</table>

    </div>
  </body>
</html>