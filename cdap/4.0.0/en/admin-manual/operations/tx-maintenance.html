<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KWLFGH');</script>
    <!-- End Google Tag Manager -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Cask Data, Inc." name="author" />
<meta content="Copyright Â© 2015-2016 Cask Data, Inc." name="copyright" />

    
    
    <meta name="git_release" content="4.0.0">
    <meta name="git_hash" content="0c15d1656b6063df42a5fcb2eea7c1bf80b1cb9b">
    <meta name="git_timestamp" content="2016-12-22 16:57:33 -0800">
    <title>Transaction Service Maintenance &mdash; Cask Data Application Platform 4.0.0 Documentation</title>

    <link rel="canonical" href="http://docs.cask.co/cdap/4.0.0/en/admin-manual/operations/tx-maintenance.html">

    
    <link rel="stylesheet" href="../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/annotator.min.css" type="text/css" />



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/copy-to-clipboard.js"></script>
    <script type="text/javascript" src="../_static/tabbed-parsed-literal.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 4.0.0 Documentation" href="../index.html" />
    <link rel="up" title="Operations" href="index.html" />
    <link rel="next" title="CDAP UI" href="cdap-ui.html" />
    <link rel="prev" title="Resource Guarantees for CDAP Programs in YARN" href="resource-guarantees.html" /> 
  </head>
  <body role="document">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KWLFGH"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="cdap-ui.html" title="CDAP UI"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="resource-guarantees.html" title="Resource Guarantees for CDAP Programs in YARN"
             accesskey="P">Previous</a> |</li>
        
        <script type="text/javascript" src="../_static/version-menu.js"></script>
        <script src="http://docs.cask.co/cdap/json-versions.js"/></script>
        <script>window.setVersion('4.0.0');</script>
       
        <li><a href="../table-of-contents.html">Administration Manual</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Operations</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div id="documentwrapper" class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="transaction-service-maintenance">
<span id="tx-maintenance"></span><h1><a class="headerlink" href="#transaction-service-maintenance" title="Perma-link to this heading">ðŸ”—</a>Transaction Service Maintenance</h1>
<div class="section" id="pruning-invalid-transactions">
<h2><a class="headerlink" href="#pruning-invalid-transactions" title="Perma-link to this heading">ðŸ”—</a>Pruning Invalid Transactions</h2>
<p>The Transaction Service keeps track of all invalid transactions so as to exclude their writes from all future reads.
Over time, this <em>invalid</em> list can grow and lead to performance degradation. To avoid that, you can prune the <em>invalid</em>
list after the data of invalid transactions has been removedâ€”the removal of which happens during major HBase
compactions of the transactional tables.</p>
<p>To prune the invalid list manually, follow these steps:</p>
<ul>
<li><p class="first">Run a major compaction on all CDAP transactional tables.</p>
</li>
<li><p class="first">Find the minimum transaction state cache reload time across all region servers before the major compaction started.
This can be done by grepping for <code class="docutils literal"><span class="pre">Transaction</span> <span class="pre">state</span> <span class="pre">reloaded</span> <span class="pre">with</span> <span class="pre">snapshot</span></code> in the HBase region server logs.</p>
<p>This should give lines such as:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">15/08/22 00:22:34 INFO coprocessor.TransactionStateCache: Transaction state reloaded with snapshot from 1440202895873</span>
<span class="go">15/08/22 00:22:42 INFO coprocessor.TransactionStateCache: Transaction state reloaded with snapshot from 1440202956306</span>
<span class="go">15/08/22 00:22:44 INFO coprocessor.TransactionStateCache: Transaction state reloaded with snapshot from 1440202956306</span>
<span class="go">15/08/22 00:22:47 INFO coprocessor.TransactionStateCache: Transaction state reloaded with snapshot from 1440202956306</span>
<span class="go">15/08/22 00:23:34 INFO coprocessor.TransactionStateCache: Transaction state reloaded with snapshot from 1440202956306</span>
</pre></div>
</div>
<p>Pick the minimum time across all region servers. In this case, <code class="docutils literal"><span class="pre">1440202895873</span></code>.</p>
</li>
<li><p class="first">Find the minimum prune time across all queues by running the tool <code class="docutils literal"><span class="pre">SimpleHBaseQueueDebugger</span></code>
(note that authorization is disabled when running the tool so that CDAP can read all users' tables):</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> /opt/cdap/master/bin/cdap run co.cask.cdap.data.tools.SimpleHBaseQueueDebugger

<span class="go">Results for queue queue:///ns1/WordCount/WordCounter/counter/queue: min tx timestamp: 1440198510309</span>
<span class="go">Results for queue queue:///ns1/WordCount/WordCounter/splitter/wordArrayOut: min tx timestamp: 1440198510280</span>
<span class="go">Results for queue queue:///ns2/WordCount/WordCounter/counter/queue: min tx timestamp: n/a</span>
<span class="go">Results for queue queue:///ns2/WordCount/WordCounter/splitter/wordArrayOut: min tx timestamp: n/a</span>
<span class="go">Results for queue queue:///default/WordCount/WordCounter/counter/queue: min tx timestamp: 1440194184568</span>
<span class="go">Results for queue queue:///default/WordCount/WordCounter/splitter/wordArrayOut: min tx timestamp: 1440194184476</span>
<span class="go">Results for queue queue:///default/WordCount/WordCounter/splitter/wordOut: min tx timestamp: 1440194184476</span>
<span class="go">Total results for all queues: min tx timestamp: 1440194184476</span>
</pre></div>
</div>
<p>Pick the timestamp from the line beginning <code class="docutils literal"><span class="pre">Total</span> <span class="pre">results</span> <span class="pre">for</span> <span class="pre">all</span> <span class="pre">queues</span></code>. In this case, <code class="docutils literal"><span class="pre">1440194184476</span></code>.</p>
</li>
<li><p class="first">Get the minimum time from the above two steps, let this be time <code class="docutils literal"><span class="pre">t</span></code>. In this case, <code class="docutils literal"><span class="pre">1440194184476</span></code>.</p>
</li>
</ul>
<p>Now, the invalid transaction list can be safely pruned
until <code class="docutils literal"><span class="pre">(t</span> <span class="pre">-</span> <span class="pre">1</span> <span class="pre">day)</span></code> using <a class="reference external" href="../source/../../reference-manual/http-restful-api/transactions.html#http-restful-api-transactions-truncate" title="(in Cask Data Application Platform v4.0.0)"><span class="xref std std-ref">a call</span></a>
with the <a class="reference external" href="../source/../../reference-manual/http-restful-api/transactions.html#http-restful-api-transactions-truncate" title="(in Cask Data Application Platform v4.0.0)"><span class="xref std std-ref">Transaction Service HTTP RESTful API</span></a>.</p>
<p>The current length of the invalid transaction list can be obtained using
<a class="reference external" href="../source/../../reference-manual/http-restful-api/transactions.html#http-restful-api-transactions-number" title="(in Cask Data Application Platform v4.0.0)"><span class="xref std std-ref">a call</span></a>
with the <a class="reference external" href="../source/../../reference-manual/http-restful-api/transactions.html#http-restful-api-transactions-number" title="(in Cask Data Application Platform v4.0.0)"><span class="xref std std-ref">Transaction Service HTTP RESTful API</span></a>.</p>
</div>
<div class="section" id="using-the-queue-debugger-tool">
<h2><a class="headerlink" href="#using-the-queue-debugger-tool" title="Perma-link to this heading">ðŸ”—</a>Using the Queue Debugger Tool</h2>
<p>The Queue Debugger Tool allows you to calculate queue statistics, and can be useful in
solving problems with queues. This is a debug tool for a queue, returning information such
as how many entries are in a queue, how many have been processed, and how many are not yet
processed.</p>
<div class="section" id="background">
<h3><a class="headerlink" href="#background" title="Perma-link to this heading">ðŸ”—</a>Background</h3>
<p>Each flow has a queue table. Within each queue table are multiple queues. There is one
queue for each connection between flowlets. As each flowlet may have multiple consuming
flowlets, this results in there being multiple queues.</p>
<p>The name of a queue is determined by the producer flowlet. The consumer flowlet (required
for the command line parameters of the tool) is referred to as the consumer.</p>
</div>
<div class="section" id="running-the-tool">
<h3><a class="headerlink" href="#running-the-tool" title="Perma-link to this heading">ðŸ”—</a>Running the Tool</h3>
<p>It's important that the tool be run with the same classpath as CDAP Master to avoid
problems with the ordering of classes and to ensure that the CDAP classes appear before
the HBase classpath. This is to avoid the invocation of any older versions of the ASM
library that are present in the HBase classpath.</p>
<p>The easiest way to start the tool with the same classpath as CDAP Master is to use:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> /etc/init.d/cdap-master run co.cask.cdap.data.tools.HBaseQueueDebugger
</pre></div>
</div>
<p>or:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> /opt/cdap/master/bin/cdap run co.cask.cdap.data.tools.HBaseQueueDebugger
</pre></div>
</div>
<p>Running the <code class="docutils literal"><span class="pre">help</span></code> option will give a summary of commands and required parameters.</p>
<p>The tool <code class="docutils literal"><span class="pre">SimpleHBaseQueueDebugger</span></code> is a wrapper of the tool that that uses a set of
defaults useful for displaying the minimum transaction time for all events in all queues.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

  <div role="note" aria-label="manuals links">
    <h3><a href="../table-of-contents/../../index.html" rel="nofollow">CDAP Documentation v4.0.0</a></h3>
    
    <ul class="this-page-menu">
      <li><div class=""></div><a href="../table-of-contents/../../introduction/index.html" rel="nofollow">Introduction to CDAP</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../developers-manual/index.html" rel="nofollow">Developersâ€™ Manual</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../admin-manual/index.html" rel="nofollow">Administration Manual</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../integrations/index.html" rel="nofollow">Integrations</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../examples-manual/index.html" rel="nofollow">Examples, Guides, and Tutorials</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/index.html" rel="nofollow">Reference Manual</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../faqs/index.html" rel="nofollow">FAQs</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/release-notes.html" rel="nofollow">Release Notes</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/glossary.html" rel="nofollow">Glossary</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../search.html" rel="nofollow">Search</a></li>
    </ul>
    <h3 class="cdap-extensions">CDAP Extensions</h3>
    
    <ul class="this-page-menu">
      <li><div class=""></div><a href="../table-of-contents/../../hydrator-manual/index.html" rel="nofollow">Cask Hydrator</a></li>
      <li><div class=""></div><a href="../table-of-contents/../../tracker-manual/index.html" rel="nofollow">Cask Tracker</a></li>
    </ul>
  </div>
    
  <h3 class="pagenavtitle"><a href="../table-of-contents.html">Administration Manual:<br> Table&nbsp;of&nbsp;Contents</a></h3>
    <nav class="pagenav">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html"> Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdap-components.html"> CDAP Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment-architectures.html"> Deployment Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hadoop-compatibility.html"> Hadoop Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../system-requirements.html"> System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html"> Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../verification.html"> Verification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html"> Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html"> Security</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html"> Operations</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="logging.html"> Logging and Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html"> Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="preferences.html"> Preferences and Runtime Arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="scaling-instances.html"> Scaling Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="resource-guarantees.html"> Resource Guarantees in YARN</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href=""> Transaction Service Maintenance</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pruning-invalid-transactions">Pruning Invalid Transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-queue-debugger-tool">Using the Queue Debugger Tool</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cdap-ui.html"> CDAP UI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/index.html"> Appendices</a></li>
</ul>
 
    </nav>
  
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/cdap/4.0.0/cdap-docs-4.0.0-web.zip"
            rel="nofollow">Zip Archive of CDAP Documentation</a></li>
    </ul>
   </div>
<div role="note" aria-label="other links">
    <h3><a href="http://docs.cask.co/" target="_blank">Documentation</a></h3>
    <ul class="this-page-menu">
        <li><a href="http://docs.cask.co/cdap/index.html" target="_blank">CDAP</a></li>
        <li><a href="http://docs.cask.co/coopr/index.html" target="_blank">Coopr</a></li>
        <li><a href="http://docs.cask.co/tigon/index.html" target="_blank">Tigon</a></li>
    </ul>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>

  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Resource Guarantees for CDAP Programs in YARN" href="resource-guarantees.html" />Resource Guarantees for CDAP Programs in YARN</a>&nbsp;&nbsp;
    </th>
    
    <th class="tg-s6z2">
        Copyright &copy; 2014-2016 Cask Data, Inc.
      &bull; Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="CDAP UI" href="cdap-ui.html" />CDAP UI</a>
    </th>

  </tr>
</table>

    </div>
  </body>
</html>