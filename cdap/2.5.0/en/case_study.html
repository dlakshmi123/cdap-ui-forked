<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta name="robots" content="noindex, nofollow">

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55081520-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>CDAP Application Case Study &mdash; Cask Data Application Platform 2.5.0 Documentation</title>
    
    <link rel="stylesheet" href="_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 2.5.0 Documentation" href="index.html" />
    <link rel="next" title="Cask Data Application Platform Concepts and Architecture" href="arch.html" />
    <link rel="prev" title="Getting Started with the Cask Data Application Platform" href="getstarted.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="arch.html" title="Cask Data Application Platform Concepts and Architecture"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="getstarted.html" title="Getting Started with the Cask Data Application Platform"
             accesskey="P">Previous</a> |</li>
        <li><a href="index.html">Cask Data Application Platform 2.5.0 Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="cdap-application-case-study">
<h1>CDAP Application Case Study<a class="headerlink" href="#cdap-application-case-study" title="Permalink to this headline">¶</a></h1>
<p><strong>Web Analytics using the Cask Data Application Platform (CDAP)</strong></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Performing analytics on a Web application using access logs is a common use case when managing a Web site.
A system capable of that needs to ingest logs, and implement real-time or batch processing computations
to process the data. The information has to be stored somewhere in the system, and
the system should expose ways to retrieve it. Even in this case where the system performs very simple analytics,
like counting the number of visits made to a website in a day, the components needed to make it possible demand
a lot of work.</p>
<p>Using Wise, which stands for Web Insights Engine Application, we’ll show you how to build such a system on CDAP
that is easy, concise, and powerful. Wise extracts information from web server access logs, counts visits made
by different IP addresses seen in the logs in real-time, and computes the bounce ratio of
each web page encountered using batch processing.</p>
<p>The Wise application uses these Cask Data Application Platform (CDAP) constructs to analyze web server logs:</p>
<ul class="simple">
<li><strong>Stream:</strong> Ingests log data in real-time</li>
<li><strong>Flow:</strong> Computes web page visits counts per IP address based on the log data in real-time</li>
<li><strong>Datasets:</strong> Store web page visits counts and bounce ratio based on custom data access patterns</li>
<li><strong>MapReduce:</strong> Computes the bounce ratio of each web page present in the log data</li>
<li><strong>Service:</strong> Exposes HTTP APIs to query the page visit counts per IP address</li>
</ul>
<p>On top of those, the <strong>Explore</strong> feature of CDAP can be used to run SQL queries on the data stored
by Wise.</p>
</div>
<div class="section" id="running-wise">
<h2>Running Wise<a class="headerlink" href="#running-wise" title="Permalink to this headline">¶</a></h2>
<p>Building and running Wise is straightforward. We&#8217;ll assume that you have already downloaded,
installed, and have started an instance of CDAP.</p>
<p>Download: <a class="reference external" href="https://github.com/caskdata/cdap-apps/tree/develop/Wise">Wise - Source code</a></p>
<p>Build the application by executing:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> mvn package
</pre></div>
</div>
<p>To deploy and start the application, make sure CDAP is running and then execute:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> bin/app-manager.sh --action deploy
<span class="gp">$</span> bin/app-manager.sh --action start
<span class="gp">$</span> bin/app-manager.sh --action status
</pre></div>
</div>
<p>On Windows, run:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> bin<span class="se">\a</span>pp-manager.bat deploy
<span class="gp">$</span> bin<span class="se">\a</span>pp-manager.bat start
<span class="gp">$</span> bin<span class="se">\a</span>pp-manager.bat status
</pre></div>
</div>
</div>
<div class="section" id="overview-of-wise">
<h2>Overview of Wise<a class="headerlink" href="#overview-of-wise" title="Permalink to this headline">¶</a></h2>
<p>Throughout this case study, we will present and explain the different constructs that the Wise application
uses. Let&#8217;s first have a look at a diagram showing an overview of the Wise application&#8217;s architecture:</p>
<img alt="_images/wise_architecture_diagram.png" src="_images/wise_architecture_diagram.png" />
<ul class="simple">
<li>The Wise application has one Stream, <tt class="docutils literal"><span class="pre">logEventStream</span></tt>, which receives Web server access logs. It sends the events
it receives to two CDAP components: the <tt class="docutils literal"><span class="pre">WiseFlow</span></tt> Flow and the <tt class="docutils literal"><span class="pre">WiseWorkflow</span></tt> Workflow.</li>
<li><tt class="docutils literal"><span class="pre">WiseFlow</span></tt> has two Flowlets. The first, <tt class="docutils literal"><span class="pre">parser</span></tt>, extracts information from the logs received from the
Stream. It then sends the information to the second Flowlet, <tt class="docutils literal"><span class="pre">pageViewCount</span></tt>, whose role is to store
the information in a custom-defined Dataset, <tt class="docutils literal"><span class="pre">pageViewStore</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">WiseWorkflow</span></tt> executes a MapReduce job every ten minutes. The input of this job are events from the Stream
which have not yet been processed by the Workflow. For each web page recorded in the
access logs, the MapReduce job counts the number of times people have &#8220;bounced&#8221; from it.
A &#8220;bounce&#8221; is counted whenever a user&#8217;s activity stops for a specified amount of time.
The last page they visited is counted as a bounce. This information is stored in the
Dataset <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt>.</li>
<li>The Wise application contains the <tt class="docutils literal"><span class="pre">WiseService</span></tt>, a Service which exposes RESTful endpoints to query the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt>
Dataset.</li>
<li>Finally, both the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> and <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt> Datasets expose a SQL interface.
They can be queried using SQL queries through our <tt class="docutils literal"><span class="pre">Explore</span></tt> module in the CDAP Console.</li>
</ul>
<p>Now let&#8217;s talk about each of these components in more detail.</p>
</div>
<div class="section" id="wise-data-patterns">
<h2>Wise Data Patterns<a class="headerlink" href="#wise-data-patterns" title="Permalink to this headline">¶</a></h2>
<p>Here&#8217;s a sample access log:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">47.41.156.173 - - [18/Sep/2014:12:52:52 -0400] &quot;POST /index.html HTTP/1.1&quot; 404 1490 &quot; &quot; &quot;Mozilla/2.0 (compatible; Ask Jeeves)&quot;</span>
</pre></div>
</div>
<p>Wise is only interested in three parts of a log:</p>
<ul class="simple">
<li>The IP address: <em>47.41.156.173</em></li>
<li>The time the log was save:, <em>18/Sep/2014:12:52:52 -0400</em>; and</li>
<li>The web page visited: <em>/index.html</em>.</li>
</ul>
<p>Wise has two Datasets, <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> and <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt>, which both store information about the access logs,
but according to different patterns.</p>
<div class="section" id="the-pageviewstore-dataset">
<h3>The <em>pageViewStore</em> Dataset<a class="headerlink" href="#the-pageviewstore-dataset" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> custom Dataset stores, for every IP address, the number of times that address has visited a web page.
For example, <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> could contain the following entry:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">47.41.156.173 -&gt; {</span>
<span class="go">  /index.html -&gt; 3,</span>
<span class="go">  /career.html -&gt; 1,</span>
<span class="go">  /team.html -&gt; 4</span>
<span class="go">}</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">pageViewStore</span></tt> uses a <tt class="docutils literal"><span class="pre">Table</span></tt> object to store this information. <tt class="docutils literal"><span class="pre">Table</span></tt> is a class provided by the CDAP
system which exposes <em>rows</em>. A row consists of a row key and one or more columns with values associated with
them. Two rows can have different sets of columns.
Using the Java <tt class="docutils literal"><span class="pre">Map</span></tt> interface, a <tt class="docutils literal"><span class="pre">Table</span></tt> can be seen as being of type <tt class="docutils literal"><span class="pre">Map&lt;byte[],</span> <span class="pre">Map&lt;byte[],</span> <span class="pre">byte[]&gt;&gt;</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">pageViewStore</span></tt> uses a <tt class="docutils literal"><span class="pre">Table</span></tt> object with this pattern:</p>
<ul class="simple">
<li>The row key of the <tt class="docutils literal"><span class="pre">Table</span></tt> is an IP address;</li>
<li>Each web page visited by the IP address is a column;</li>
<li>The value of each column is the count of visits the IP address has made to the web page URI.</li>
</ul>
<p><tt class="docutils literal"><span class="pre">pageViewStore</span></tt> is a custom Dataset. It is defined in the <tt class="docutils literal"><span class="pre">PageViewStore</span></tt> class
such that it includes the use of a <tt class="docutils literal"><span class="pre">Table</span></tt> to store the data:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageViewStore</span> <span class="kd">extends</span> <span class="n">AbstractDataset</span>
  <span class="o">...</span> <span class="o">{</span>

  <span class="c1">// Define the underlying table</span>
  <span class="kd">private</span> <span class="n">Table</span> <span class="n">table</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">PageViewStore</span><span class="o">(</span><span class="n">DatasetSpecification</span> <span class="n">spec</span><span class="o">,</span> <span class="nd">@EmbeddedDataset</span><span class="o">(</span><span class="s">&quot;tracks&quot;</span><span class="o">)</span> <span class="n">Table</span> <span class="n">table</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">spec</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">table</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This is the common way of defining a custom Dataset. The next step is to define the API that this Dataset exposes
to store and access data. The API for storing data will be a single method:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">incrementCount</span><span class="o">(</span><span class="n">LogInfo</span> <span class="n">logInfo</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">table</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="k">new</span> <span class="n">Increment</span><span class="o">(</span><span class="n">logInfo</span><span class="o">.</span><span class="na">getIp</span><span class="o">(),</span> <span class="n">logInfo</span><span class="o">.</span><span class="na">getUri</span><span class="o">(),</span> <span class="mi">1L</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">incrememtCount()</span></tt> takes a <tt class="docutils literal"><span class="pre">LogInfo</span></tt> object, which contains those three parts of a log that we are interested
in—-IP address, timestamp, and web page-—and increments the number of visits of the web page for that IP address.
We use the underlying <tt class="docutils literal"><span class="pre">Table</span></tt>&#8216;s <tt class="docutils literal"><span class="pre">increment()</span></tt> method to store this information.</p>
<p>Let&#8217;s look at how to make the data available through our <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> Dataset:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">long</span> <span class="nf">getCounts</span><span class="o">(</span><span class="n">String</span> <span class="n">ipAddress</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">new</span> <span class="n">Get</span><span class="o">(</span><span class="n">ipAddress</span><span class="o">));</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">row</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">row</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">row</span><span class="o">.</span><span class="na">getColumns</span><span class="o">().</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toLong</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This method returns the total number of visits an IP address has made. To do so, it uses the <tt class="docutils literal"><span class="pre">Table.get()</span></tt> method,
which returns a <tt class="docutils literal"><span class="pre">Row</span></tt> object containing all the columns associated to the row key passed as argument of
<tt class="docutils literal"><span class="pre">Table.get()</span></tt>.</p>
</div>
<div class="section" id="the-bouncecountstore-dataset">
<h3>The <em>bounceCountStore</em> Dataset<a class="headerlink" href="#the-bouncecountstore-dataset" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt> Dataset stores the total number of visits for each web page, along with the number
of times users bounced off of them.</p>
<p>Data is stored in a <tt class="docutils literal"><span class="pre">Table</span></tt> object with the pattern:</p>
<ul class="simple">
<li>the row key is the web page URI;</li>
<li>each row has two columns: <tt class="docutils literal"><span class="pre">COL_VISITS</span></tt> and <tt class="docutils literal"><span class="pre">COL_BOUNCES</span></tt>;</li>
<li>the <tt class="docutils literal"><span class="pre">COL_VISITS</span></tt> column stores the total number of visits for the web page considered; and</li>
<li>the <tt class="docutils literal"><span class="pre">COL_BOUNCES</span></tt> column stores the number of times users bounced off the web page.</li>
</ul>
<p>Let&#8217;s detail the API exposed by the <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt> Dataset to store this information:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">COL_VISITS</span> <span class="o">=</span> <span class="s">&quot;v&quot;</span><span class="o">;</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">COL_BOUNCES</span> <span class="o">=</span> <span class="s">&quot;b&quot;</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Increment a bounce count entry with the specified number of visits and bounces.</span>
<span class="cm"> *</span>
<span class="cm"> * @param uri URI of the web page</span>
<span class="cm"> * @param visits number of visits to add to the web page</span>
<span class="cm"> * @param bounces number of bounces to add to the web page</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">increment</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">,</span> <span class="kt">long</span> <span class="n">visits</span><span class="o">,</span> <span class="kt">long</span> <span class="n">bounces</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">table</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="k">new</span> <span class="n">Increment</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">COL_VISITS</span><span class="o">,</span> <span class="n">visits</span><span class="o">));</span>
  <span class="n">table</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="k">new</span> <span class="n">Increment</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">COL_BOUNCES</span><span class="o">,</span> <span class="n">bounces</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">increment()</span></tt> method modifies the counts of &#8220;visits&#8221; and &#8220;bounces&#8221; attached to a web page, by adding
the number passed in parameters. It uses the  <tt class="docutils literal"><span class="pre">Table.increment()</span></tt> method to do so.</p>
<p>To retrieve the number of &#8220;visits&#8221; and &#8220;bounces&#8221; for a particular web page, we define a <tt class="docutils literal"><span class="pre">get()</span></tt> method:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Retrieve a bounce counts entry from this {@link BounceCountsStore}.</span>
<span class="cm"> *</span>
<span class="cm"> * @param uri URI of the web page</span>
<span class="cm"> * @return the bounce counts entry associated to the web page with the {@code uri}</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="n">PageBounce</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">new</span> <span class="n">Get</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">ImmutableList</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">COL_VISITS</span><span class="o">,</span> <span class="n">COL_BOUNCES</span><span class="o">)));</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">PageBounce</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kt">long</span> <span class="n">visits</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">COL_VISITS</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
  <span class="kt">long</span> <span class="n">bounces</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">COL_BOUNCES</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">PageBounce</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">visits</span><span class="o">,</span> <span class="n">bounces</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">get()</span></tt> method reads the two columns <tt class="docutils literal"><span class="pre">COL_VISITS</span></tt> and <tt class="docutils literal"><span class="pre">COL_BOUNCES</span></tt> of a web page. Once again,
we use the <tt class="docutils literal"><span class="pre">Table.get()</span></tt> method which returns a <tt class="docutils literal"><span class="pre">Row</span></tt> object. From the information contained in the <tt class="docutils literal"><span class="pre">Row</span></tt>
object, we build a <tt class="docutils literal"><span class="pre">PageBounce</span></tt> object, a simple POJO class, containing a <tt class="docutils literal"><span class="pre">uri</span></tt>,
a <tt class="docutils literal"><span class="pre">visits</span></tt> count and a <tt class="docutils literal"><span class="pre">bounces</span></tt> count.</p>
</div>
</div>
<div class="section" id="ingesting-access-logs-in-wise">
<h2>Ingesting Access Logs in Wise<a class="headerlink" href="#ingesting-access-logs-in-wise" title="Permalink to this headline">¶</a></h2>
<p>CDAP has an easy way to ingest data in real time into an application, using <strong>Streams</strong>. A Stream exposes
a simple <a class="reference internal" href="api.html#rest-streams"><em>REST API</em></a> to ingest data events.</p>
<p>In Wise, each web server access log is injected as a Stream event to the <tt class="docutils literal"><span class="pre">logEventStream</span></tt> in this format:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">47.41.156.173 - - [18/Sep/2014:12:52:52 -0400] &quot;POST /index.html HTTP/1.1&quot;  404 1490 &quot; &quot; &quot;Mozilla/2.0 (compatible; Ask Jeeves)&quot;</span>
</pre></div>
</div>
<p>We have already prepared a sample of Web server access logs for you to inject into the <tt class="docutils literal"><span class="pre">logEventStream</span></tt>.
On Unix systems, run this command at the root of the Wise application:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> bin/inject-data.sh
</pre></div>
</div>
<p>On Windows, run:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> bin/inject-data.bat
</pre></div>
</div>
<p>This requires that a Standalone CDAP instance be running with the Wise application already deployed.</p>
</div>
<div class="section" id="real-time-log-analytics-with-wiseflow">
<h2>Real-time Log Analytics with WiseFlow<a class="headerlink" href="#real-time-log-analytics-with-wiseflow" title="Permalink to this headline">¶</a></h2>
<p>The goal of <tt class="docutils literal"><span class="pre">WiseFlow</span></tt> is to perform real-time analytics on the Web server access logs
received by <tt class="docutils literal"><span class="pre">logEventStream</span></tt>. For each IP address in the logs, <tt class="docutils literal"><span class="pre">WiseFlow</span></tt> counts the
number of visits they made to different web pages.</p>
<p>This work is realized by two Flowlets, <tt class="docutils literal"><span class="pre">parser</span></tt> and <tt class="docutils literal"><span class="pre">pageViewCount</span></tt>.</p>
<div class="section" id="the-parser-flowlet">
<h3>The <em>parser</em> Flowlet<a class="headerlink" href="#the-parser-flowlet" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">parser</span></tt> receives the raw log data from the Stream and extracts the timestamp,
the IP address and the web page visited. Here is its implementation:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LogEventParserFlowlet</span> <span class="kd">extends</span> <span class="n">AbstractFlowlet</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">LogEventParserFlowlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="c1">// Emitter for emitting a LogInfo instance to the next Flowlet</span>
  <span class="kd">private</span> <span class="n">OutputEmitter</span><span class="o">&lt;</span><span class="n">LogInfo</span><span class="o">&gt;</span> <span class="n">output</span><span class="o">;</span>

  <span class="c1">// Annotation indicates that this method can process incoming data</span>
  <span class="nd">@ProcessInput</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processFromStream</span><span class="o">(</span><span class="n">StreamEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// Get a log event in String format from a StreamEvent instance</span>
    <span class="n">String</span> <span class="n">log</span> <span class="o">=</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getBody</span><span class="o">()).</span><span class="na">toString</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="n">LogInfo</span> <span class="n">logInfo</span> <span class="o">=</span> <span class="n">LogInfo</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">log</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">logInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="n">logInfo</span><span class="o">,</span> <span class="s">&quot;ip&quot;</span><span class="o">,</span> <span class="n">logInfo</span><span class="o">.</span><span class="na">getIp</span><span class="o">().</span><span class="na">hashCode</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Exception while processing log event {}&quot;</span><span class="o">,</span> <span class="n">log</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Could not parse log event {}&quot;</span><span class="o">,</span> <span class="n">log</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>A Flowlet class first extends the <tt class="docutils literal"><span class="pre">AbstractFlowlet</span></tt> class. The <tt class="docutils literal"><span class="pre">LogEventParserFlowlet</span></tt> class contains
one method to process the data it receives from <tt class="docutils literal"><span class="pre">logEventStream</span></tt>.
This method can have any name; here, we call it <tt class="docutils literal"><span class="pre">processFromStream</span></tt>. It has to bear the <tt class="docutils literal"><span class="pre">&#64;ProcessInput</span></tt>
annotation indicating that the method will be used to process incoming data.</p>
<p>Because the <tt class="docutils literal"><span class="pre">parser</span></tt> Flowlet receives data from a Stream, the <tt class="docutils literal"><span class="pre">processFromStream</span></tt> method has to take one and only
one argument of type <tt class="docutils literal"><span class="pre">StreamEvent</span></tt>. A <tt class="docutils literal"><span class="pre">StreamEvent</span></tt> object contains the header and the body of a Stream event.
In the Wise application, the body of a <tt class="docutils literal"><span class="pre">StreamEvent</span></tt> will be a Web server access log.</p>
<p>The <tt class="docutils literal"><span class="pre">parser</span></tt> Flowlet parses every log it receives into one <tt class="docutils literal"><span class="pre">LogInfo</span></tt> object. Using an <tt class="docutils literal"><span class="pre">OutputEmitter&lt;LogInfo&gt;</span></tt>
object, <tt class="docutils literal"><span class="pre">parser</span></tt> outputs those logs to the next Flowlet input—the <tt class="docutils literal"><span class="pre">pageViewCount</span></tt> Flowlet.
When a <tt class="docutils literal"><span class="pre">LogInfo</span></tt> object is emitted, it is hashed by IP address. We’ll see below why this is useful.</p>
</div>
<div class="section" id="the-pageviewcount-flowlet">
<h3>The <em>pageViewCount</em> Flowlet<a class="headerlink" href="#the-pageviewcount-flowlet" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">pageViewCount</span></tt> Flowlet receives <tt class="docutils literal"><span class="pre">LogInfo</span></tt> objects and updates the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> Dataset with the
information they contain.</p>
<p>Its implementation is very brief:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PageViewCounterFlowlet</span> <span class="kd">extends</span> <span class="n">AbstractFlowlet</span> <span class="o">{</span>
  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="s">&quot;pageViewStore&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">PageViewStore</span> <span class="n">pageViewStore</span><span class="o">;</span>

  <span class="nd">@Batch</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
  <span class="nd">@HashPartition</span><span class="o">(</span><span class="s">&quot;ip&quot;</span><span class="o">)</span>
  <span class="nd">@ProcessInput</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">count</span><span class="o">(</span><span class="n">LogInfo</span> <span class="n">logInfo</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Increment the count of a logInfo by 1</span>
    <span class="n">pageViewStore</span><span class="o">.</span><span class="na">incrementCount</span><span class="o">(</span><span class="n">logInfo</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Here&#8217;s what to note about the <tt class="docutils literal"><span class="pre">PageViewCounterFlowlet</span></tt> Flowlet class:</p>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">&#64;ProcessInput</span></tt> annotation on the <tt class="docutils literal"><span class="pre">count()</span></tt> method indicates that <tt class="docutils literal"><span class="pre">count()</span></tt> will process incoming data.</li>
<li>The <tt class="docutils literal"><span class="pre">&#64;UseDataSet</span></tt> annotation gives a reference to the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> Dataset inside the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt>
attribute. The Dataset APIs can then be used inside the <tt class="docutils literal"><span class="pre">count()</span></tt> method to store logs analytics.</li>
<li>The <tt class="docutils literal"><span class="pre">&#64;Batch</span></tt> annotation indicates that data is processed in batches of ten <tt class="docutils literal"><span class="pre">LogInfo</span></tt> objects,
which increases the throughput of the Flowlet.</li>
<li>The <tt class="docutils literal"><span class="pre">&#64;HashPartition</span></tt> annotation ensures, in the case that several instances of this Flowlet are running, all
<tt class="docutils literal"><span class="pre">LogInfo</span></tt> objects with the same IP address information will be sent to the same Flowlet instance.
This prevents two Flowlet instances from writing to the same row key of the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> Dataset at the
same time, which would cause a transaction conflict. (See the <a class="reference external" href="advanced.html">advanced</a> guide for more
information about transactions and conflicts.)</li>
</ul>
</div>
<div class="section" id="building-the-wiseflow">
<h3>Building the WiseFlow<a class="headerlink" href="#building-the-wiseflow" title="Permalink to this headline">¶</a></h3>
<p>Now that we have had a look at the core of the <tt class="docutils literal"><span class="pre">parser</span></tt> and <tt class="docutils literal"><span class="pre">pageViewCount</span></tt> Flowlets, let&#8217;s see how
they are connected together and to <tt class="docutils literal"><span class="pre">logEventStream</span></tt>.</p>
<p>The Flowlets are defined in the <tt class="docutils literal"><span class="pre">WiseFlow</span></tt> Flow, which is defined by this small class:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WiseFlow</span> <span class="kd">implements</span> <span class="n">Flow</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">FlowSpecification</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">FlowSpecification</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">with</span><span class="o">()</span>
      <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;WiseFlow&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">&quot;Wise Flow&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">withFlowlets</span><span class="o">()</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;parser&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">LogEventParserFlowlet</span><span class="o">())</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;pageViewCount&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PageViewCounterFlowlet</span><span class="o">())</span>
      <span class="o">.</span><span class="na">connect</span><span class="o">()</span>
        <span class="o">.</span><span class="na">fromStream</span><span class="o">(</span><span class="s">&quot;logEventStream&quot;</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;parser&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;parser&quot;</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;pageViewCount&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>In the <tt class="docutils literal"><span class="pre">configure()</span></tt> method of the <tt class="docutils literal"><span class="pre">WiseFlow</span></tt> Flow, we define the Flowlets, giving them names:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">parser</span></tt>, of type <tt class="docutils literal"><span class="pre">LogEventParserFlowlet</span></tt>; and</li>
<li><tt class="docutils literal"><span class="pre">pageViewCount</span></tt>, of type <tt class="docutils literal"><span class="pre">PageViewCounterFlowlet</span></tt>.</li>
</ul>
<p>We also define the graph of their connections:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">logEventStream</span></tt> Stream is connected to the <tt class="docutils literal"><span class="pre">parser</span></tt> Flowlet; and</li>
<li><tt class="docutils literal"><span class="pre">parser</span></tt> Flowlet is connected to the <tt class="docutils literal"><span class="pre">pageViewCount</span></tt> Flowlet.</li>
</ul>
<p>Here is how <tt class="docutils literal"><span class="pre">WiseFlow</span></tt> looks in the CDAP Console:</p>
<img alt="_images/wise_flow.png" src="_images/wise_flow.png" />
</div>
</div>
<div class="section" id="batch-processing-of-logs-with-wiseworkflow">
<h2>Batch Processing of Logs with WiseWorkflow<a class="headerlink" href="#batch-processing-of-logs-with-wiseworkflow" title="Permalink to this headline">¶</a></h2>
<p>Wise executes every ten minutes a MapReduce job that computes the bounce counts of the web pages
seen in the Web server access logs.</p>
<p>The <tt class="docutils literal"><span class="pre">BounceCountsMapReduce</span></tt> class defines the MapReduce job to run. It extends
<tt class="docutils literal"><span class="pre">AbstractMapReduce</span></tt> and overrides the two methods <tt class="docutils literal"><span class="pre">configure()</span></tt> and <tt class="docutils literal"><span class="pre">beforeSubmit()</span></tt>.
The <tt class="docutils literal"><span class="pre">configure()</span></tt> method is defined as:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">MapReduceSpecification</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">MapReduceSpecification</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">with</span><span class="o">()</span>
    <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;BounceCountsMapReduce&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">&quot;Bounce Counts MapReduce job&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">useDataSet</span><span class="o">(</span><span class="s">&quot;bounceCountsMapReduceLastRun&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">useOutputDataSet</span><span class="o">(</span><span class="s">&quot;bounceCountStore&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
<p>It sets the ID of the MapReduce job, <tt class="docutils literal"><span class="pre">BounceCountsMapReduce</span></tt>, and specifies which Datasets will be used in the job.
This job uses the <tt class="docutils literal"><span class="pre">bounceCountsMapReduceLastRun</span></tt> system Dataset—of type <tt class="docutils literal"><span class="pre">KeyValueTable</span></tt>—to
store the time of the last successful run of <tt class="docutils literal"><span class="pre">BounceCountsMapReduce</span></tt>.</p>
<p>We will talk about the <tt class="docutils literal"><span class="pre">useOutputDataset()</span></tt> method in only a minute.</p>
<div class="section" id="plugging-the-stream-to-the-input-of-the-mapreduce-job">
<h3>Plugging the Stream to the Input of the MapReduce Job<a class="headerlink" href="#plugging-the-stream-to-the-input-of-the-mapreduce-job" title="Permalink to this headline">¶</a></h3>
<p>Traditionally in a MapReduce job, a Job configuration is set before each run. This is done in the <tt class="docutils literal"><span class="pre">beforeSubmit()</span></tt>
method of the <tt class="docutils literal"><span class="pre">BounceCountsMapReduce</span></tt> class:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeSubmit</span><span class="o">(</span><span class="n">MapReduceContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
  <span class="n">Job</span> <span class="n">job</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getHadoopJob</span><span class="o">();</span>
  <span class="o">...</span>
  <span class="n">KeyValueTable</span> <span class="n">lastRunDataset</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDataSet</span><span class="o">(</span><span class="s">&quot;bounceCountsMapReduceLastRun&quot;</span><span class="o">);</span>
  <span class="o">...</span>
  <span class="n">StreamBatchReadable</span><span class="o">.</span><span class="na">useStreamInput</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="s">&quot;logEventStream&quot;</span><span class="o">,</span> <span class="n">startTime</span><span class="o">,</span> <span class="n">endTime</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>As mentioned earlier, the input of the MapReduce job is the <tt class="docutils literal"><span class="pre">logEventStream</span></tt>. This connection is made above using
the <tt class="docutils literal"><span class="pre">StreamBatchReadable.useStreamInput()</span></tt> method.</p>
<p>The <tt class="docutils literal"><span class="pre">startTime</span></tt> is computed using the last value stored in the <tt class="docutils literal"><span class="pre">bounceCountsMapReduceLastRun</span></tt> Dataset, which can
be accessed using the <tt class="docutils literal"><span class="pre">MapReduceContext.getDataSet()</span></tt> method.</p>
</div>
<div class="section" id="writing-to-the-bouncecountstore-dataset-from-the-mapreduce-job">
<h3>Writing to the <em>bounceCountStore</em> Dataset from the MapReduce Job<a class="headerlink" href="#writing-to-the-bouncecountstore-dataset-from-the-mapreduce-job" title="Permalink to this headline">¶</a></h3>
<p>In the <tt class="docutils literal"><span class="pre">BounceCountsMapReduce.configure()</span></tt> method seen earlier, the <tt class="docutils literal"><span class="pre">useOutputDataset</span></tt> method sets the
<tt class="docutils literal"><span class="pre">bounceCountsStore</span></tt> Dataset as the output of the job.
It means that the key/value pairs output by the reducer of the job will be directly written to that Dataset.</p>
<p>To allow that, the <tt class="docutils literal"><span class="pre">bounceCountsStore</span></tt> Dataset has to implement the <tt class="docutils literal"><span class="pre">BatchWritable</span></tt> interface:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BounceCountsStore</span> <span class="kd">extends</span> <span class="n">AbstractDataset</span>
  <span class="kd">implements</span> <span class="n">BatchWritable</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">PageBounce</span><span class="o">&gt;,</span> <span class="o">...</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Void</span> <span class="n">ignored</span><span class="o">,</span> <span class="n">PageBounce</span> <span class="n">pageBounce</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="n">pageBounce</span><span class="o">.</span><span class="na">getUri</span><span class="o">(),</span> <span class="n">pageBounce</span><span class="o">.</span><span class="na">getTotalVisits</span><span class="o">(),</span> <span class="n">pageBounce</span><span class="o">.</span><span class="na">getBounces</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This <tt class="docutils literal"><span class="pre">BatchWritable</span></tt> interface, defining a <tt class="docutils literal"><span class="pre">write()</span></tt> method, is intended to allow Datasets to be the output of
MapReduce jobs. The two generic types that it takes as parameters must match the types of the key
and value that the Reduce part of the job outputs. In this case, the <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt> Dataset can be
used as output of a MapReduce job where the output key is of type <tt class="docutils literal"><span class="pre">Void</span></tt>, and the output value is of type
<tt class="docutils literal"><span class="pre">PageBounce</span></tt>.</p>
</div>
<div class="section" id="mapreduce-job-structure">
<h3>MapReduce Job Structure<a class="headerlink" href="#mapreduce-job-structure" title="Permalink to this headline">¶</a></h3>
<p>The Mapper of the job receives log events as input, parses them into <tt class="docutils literal"><span class="pre">LogInfo</span></tt> objects and send them to the Reducer.
The Reducer receives the <tt class="docutils literal"><span class="pre">LogInfo</span></tt> objects grouped by IP addresses, with two logs with the same IP address sorted
by timestamp in ascending order.</p>
<p>Because the input of our MapReduce job is a Stream, it forces the key and value types of our Mapper to be
<tt class="docutils literal"><span class="pre">LongWritable</span></tt> and <tt class="docutils literal"><span class="pre">Text</span></tt>, respectively.</p>
<p>Our <tt class="docutils literal"><span class="pre">Mapper</span></tt> and <tt class="docutils literal"><span class="pre">Reducer</span></tt> are standard Hadoop classes with these signatures:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BounceCountsMapper</span> <span class="kd">extends</span> <span class="n">Mapper</span><span class="o">&lt;</span><span class="n">LongWritable</span><span class="o">,</span> <span class="n">Text</span><span class="o">,</span> <span class="n">LogInfo</span><span class="o">,</span> <span class="n">IntWritable</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BounceCountsReducer</span> <span class="kd">extends</span> <span class="n">Reducer</span><span class="o">&lt;</span><span class="n">LogInfo</span><span class="o">,</span> <span class="n">IntWritable</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">PageBounce</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Each generic parameter of the <tt class="docutils literal"><span class="pre">Mapper</span></tt> and the <tt class="docutils literal"><span class="pre">Reducer</span></tt> contains:</p>
<ul class="simple">
<li>Mapper input key <tt class="docutils literal"><span class="pre">LongWritable</span></tt>: the timestamp of when a Stream event has been received;</li>
<li>Mapper input value <tt class="docutils literal"><span class="pre">Text</span></tt>: body of a Stream event, in this case the log data;</li>
<li>Mapper output key and Reducer input key <tt class="docutils literal"><span class="pre">LogInfo</span></tt>: a POJO object containing information about
one log line;</li>
<li>Mapper output value and Reducer input value <tt class="docutils literal"><span class="pre">IntWritable</span></tt>: a simple placeholder as we
don&#8217;t use its content;</li>
<li>Reducer output key <tt class="docutils literal"><span class="pre">Void</span></tt>: this is not used; and</li>
<li>Reducer output value <tt class="docutils literal"><span class="pre">PageBounce</span></tt>: bounce counts of a web page.</li>
</ul>
</div>
<div class="section" id="scheduling-the-mapreduce-job">
<h3>Scheduling the MapReduce Job<a class="headerlink" href="#scheduling-the-mapreduce-job" title="Permalink to this headline">¶</a></h3>
<p>To schedule the <tt class="docutils literal"><span class="pre">BounceCountsMapReduce</span></tt> job to run every ten minute, we define it in the
<tt class="docutils literal"><span class="pre">WiseWorkflow</span></tt> as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WiseWorkflow</span> <span class="kd">implements</span> <span class="n">Workflow</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">WorkflowSpecification</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">WorkflowSpecification</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">with</span><span class="o">()</span>
      <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;WiseWorkflow&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">&quot;Wise Workflow&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">onlyWith</span><span class="o">(</span><span class="k">new</span> <span class="n">BounceCountsMapReduce</span><span class="o">())</span>
      <span class="o">.</span><span class="na">addSchedule</span><span class="o">(</span><span class="k">new</span> <span class="n">Schedule</span><span class="o">(</span><span class="s">&quot;TenMinuteSchedule&quot;</span><span class="o">,</span> <span class="s">&quot;Run every 10 minutes&quot;</span><span class="o">,</span> <span class="s">&quot;0/10 * * * *&quot;</span><span class="o">,</span>
                                <span class="n">Schedule</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">START</span><span class="o">))</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="accessing-wise-data-through-wiseservice">
<h2>Accessing Wise Data through WiseService<a class="headerlink" href="#accessing-wise-data-through-wiseservice" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">WiseService</span></tt> is a Wise component that exposes specific HTTP endpoints to retrieve the content of the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt>
Dataset. For example, <tt class="docutils literal"><span class="pre">WiseService</span></tt> defines this endpoint:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">GET</span> <span class="nl">http:</span><span class="c1">//localhost:10000/v2/apps/Wise/services/WiseService/methods/ip/164.199.169.153/count</span>
</pre></div>
</div>
<p>This endpoint is defined in a class extending <tt class="docutils literal"><span class="pre">AbstractHttpServiceHandler</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PageViewCountHandler</span> <span class="kd">extends</span> <span class="n">AbstractHttpServiceHandler</span> <span class="o">{</span>
  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="s">&quot;pageViewStore&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">PageViewStore</span> <span class="n">pageViewStore</span><span class="o">;</span>

  <span class="nd">@GET</span>
  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/ip/{ip}/count&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getIPCount</span><span class="o">(</span><span class="n">HttpServiceRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServiceResponder</span> <span class="n">responder</span><span class="o">,</span>
                         <span class="nd">@PathParam</span><span class="o">(</span><span class="s">&quot;ip&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">ipAddress</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">pageViewStore</span><span class="o">.</span><span class="na">getCounts</span><span class="o">(</span><span class="n">ipAddress</span><span class="o">);</span>
    <span class="n">responder</span><span class="o">.</span><span class="na">sendJson</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">counts</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">PageViewCountHandler</span></tt> class accesses the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> Dataset using the same <tt class="docutils literal"><span class="pre">&#64;UseDataSet</span></tt>
annotation used in the <tt class="docutils literal"><span class="pre">PageViewCounterFlowlet</span></tt> class.</p>
<p>The endpoint defined above in the <tt class="docutils literal"><span class="pre">getIPCount()</span></tt> method will retrieve the number of times a given IP address
has been seen in the access logs by using the APIs of the <tt class="docutils literal"><span class="pre">pageViewStore</span></tt> Dataset.</p>
<p>The <tt class="docutils literal"><span class="pre">&#64;GET</span></tt> annotation specifies the HTTP method used to reach the endpoint. The
<tt class="docutils literal"><span class="pre">&#64;Path</span></tt> annotation defines the URL path used to reach this endpoint. This path has a
single user parameter, <tt class="docutils literal"><span class="pre">{ip}</span></tt>. It is decoded as a <tt class="docutils literal"><span class="pre">String</span></tt> in the parameters of the
<tt class="docutils literal"><span class="pre">getIPCount()</span></tt> method with the help of the <tt class="docutils literal"><span class="pre">&#64;PathParam</span></tt> annotation.</p>
<p>The <tt class="docutils literal"><span class="pre">PageViewCountHandler</span></tt> class is registered in the <tt class="docutils literal"><span class="pre">WiseService</span></tt> class, which has the implementation:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">WiseService</span> <span class="kd">extends</span> <span class="n">AbstractService</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">setName</span><span class="o">(</span><span class="s">&quot;PageViewService&quot;</span><span class="o">);</span>
    <span class="n">addHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">PageViewCountHandler</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<ul class="simple">
<li>The class sets the ID of the service, and this ID will be used in the URL to reach the
endpoints defined by the service.</li>
<li>The <tt class="docutils literal"><span class="pre">PageViewCountHandler</span></tt> that responds to the HTTP endpoint exposed by the Service is
specified by the <tt class="docutils literal"><span class="pre">addHandler()</span></tt> method.</li>
</ul>
<p>We have created a script to query the HTTP endpoints defined by the <tt class="docutils literal"><span class="pre">WiseService</span></tt>. In the root of the <tt class="docutils literal"><span class="pre">Wise</span></tt>
application, execute:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">call</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="na">sh</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">255.154</span>
<span class="n">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">call</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="na">sh</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">255.154</span> <span class="o">--</span><span class="n">uri</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="na">html</span>
</pre></div>
</div>
<p>On Windows, execute:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">call</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="na">bat</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">255.154</span>
<span class="n">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">call</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="na">bat</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">255.154</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="na">html</span>
</pre></div>
</div>
</div>
<div class="section" id="exploring-wise-datasets-through-sql">
<h2>Exploring Wise Datasets through SQL<a class="headerlink" href="#exploring-wise-datasets-through-sql" title="Permalink to this headline">¶</a></h2>
<p>With Wise, you can explore the Datasets using SQL queries. The SQL interface on CDAP, called Explore,
can be accessed through the CDAP Console:</p>
<ol class="arabic">
<li><p class="first">After deploying Wise in your Standalone CDAP instance, go to the <strong>Store</strong> page,
which is one of the five pages you can access from the left pane of CDAP Console:</p>
<img alt="_images/wise_store_page.png" src="_images/wise_store_page.png" />
</li>
<li><p class="first">Click on the <strong>Explore</strong> button in the top-right corner of the page. You will land on this page:</p>
<img alt="_images/wise_explore_page.png" src="_images/wise_explore_page.png" />
</li>
</ol>
<p>This is the <em>Explore</em> page, where you can run ad-hoc SQL queries and see information about the Datasets that expose
a SQL interface.</p>
<p>You will notice that the Datasets have unusual names, such as <em>cdap_user_bouncecounts</em>. Those are the SQL table names
of the Datasets which have a SQL interface.</p>
<p>Here are some of the SQL queries that you can run:</p>
<ul>
<li><p class="first">Retrieve the web pages from where IP addresses have bounced more than 50% of the time:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">SELECT</span> <span class="n">uri</span> <span class="n">FROM</span> <span class="n">cdap_user_bouncecountstore</span> <span class="n">WHERE</span> <span class="n">bounces</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">totalvisits</span>
</pre></div>
</div>
</li>
<li><p class="first">Retrieve all the IP addresses which visited the page &#8216;/contact.html&#8217;:</p>
<div class="highlight-java"><div class="highlight"><pre>SELECT key FROM cdap_user_pageviewstore WHERE array_contains(map_keys(value), &#39;/contact.html&#39;)=TRUE
</pre></div>
</div>
</li>
</ul>
<p>As the SQL engine that CDAP runs internally is Hive, the SQL language used to submit queries is HiveQL.
A description of it is in the <a class="reference external" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-InsertingdataintoHiveTablesfromqueries">Hive language manual</a>.</p>
<p>Let&#8217;s take a look at the schemas of the <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt> Dataset. The <em>Explore</em> interface shows that
it has three columns: <cite>uri</cite>, <cite>totalvisits</cite>, and <cite>bounces</cite>.</p>
<p>To understand how we managed to attach this schema to the <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt> Dataset, let&#8217;s have another look
at the Dataset&#8217;s class definition:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BounceCountsStore</span> <span class="kd">extends</span> <span class="n">AbstractDataset</span>
  <span class="kd">implements</span> <span class="o">...,</span> <span class="n">RecordScannable</span><span class="o">&lt;</span><span class="n">PageBounce</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">RecordScannable</span></tt> interface allows a Dataset to be queried using SQL. It exposes a Dataset as a table
of <tt class="docutils literal"><span class="pre">Record</span></tt> objects, and the schema of the <tt class="docutils literal"><span class="pre">Record</span></tt> defines the schema of the Dataset as seen as a
SQL table.</p>
<p>The <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt> Dataset&#8217;s <tt class="docutils literal"><span class="pre">Record</span></tt> type is <tt class="docutils literal"><span class="pre">PageBounce</span></tt>, which is a POJO object containing three attributes:
<cite>uri</cite>, <cite>totalVisits</cite>, and <cite>bounces</cite>. It explains where the schema of the <tt class="docutils literal"><span class="pre">bounceCountStore</span></tt> is derived.</p>
</div>
<div class="section" id="bringing-the-wise-components-together">
<h2>Bringing the Wise Components Together<a class="headerlink" href="#bringing-the-wise-components-together" title="Permalink to this headline">¶</a></h2>
<p>To create the Wise application with all these components mentioned above, define a class that extends
<tt class="docutils literal"><span class="pre">AbstractApplication</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WiseApp</span> <span class="kd">extends</span> <span class="n">AbstractApplication</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">setName</span><span class="o">(</span><span class="s">&quot;Wise&quot;</span><span class="o">);</span>
    <span class="n">setDescription</span><span class="o">(</span><span class="s">&quot;Web Insights Engine&quot;</span><span class="o">);</span>
    <span class="n">addStream</span><span class="o">(</span><span class="k">new</span> <span class="n">Stream</span><span class="o">(</span><span class="s">&quot;logEventStream&quot;</span><span class="o">));</span>
    <span class="n">createDataset</span><span class="o">(</span><span class="s">&quot;pageViewStore&quot;</span><span class="o">,</span> <span class="n">PageViewStore</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">createDataset</span><span class="o">(</span><span class="s">&quot;bounceCountStore&quot;</span><span class="o">,</span> <span class="n">BounceCountStore</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">createDataset</span><span class="o">(</span><span class="s">&quot;bounceCountsMapReduceLastRun&quot;</span><span class="o">,</span> <span class="n">KeyValueTable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">addFlow</span><span class="o">(</span><span class="k">new</span> <span class="n">WiseFlow</span><span class="o">());</span>
    <span class="n">addWorkflow</span><span class="o">(</span><span class="k">new</span> <span class="n">WiseWorkflow</span><span class="o">());</span>
    <span class="n">addService</span><span class="o">(</span><span class="k">new</span> <span class="n">WiseService</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>When the Wise application is deployed in CDAP, this class is read by the CDAP system. All the components
it defines are then installed, and can reference one another.</p>
</div>
<div class="section" id="unit-testing-wise">
<h2>Unit testing Wise<a class="headerlink" href="#unit-testing-wise" title="Permalink to this headline">¶</a></h2>
<p>Unit tests are a major part of the development of an application. As developers ourselves, we have created a
full unit testing framework for CDAP applications. In a CDAP application unit tests, all CDAP components run in-memory.</p>
<p>The <tt class="docutils literal"><span class="pre">WiseAppTest</span></tt> class, which extends the unit-testing framework&#8217;s <tt class="docutils literal"><span class="pre">TestBase</span></tt>, tests all the components of the WiseApp.
The first step is to obtain an <tt class="docutils literal"><span class="pre">ApplicationManager</span></tt> object:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">ApplicationManager</span> <span class="n">appManager</span> <span class="o">=</span> <span class="n">deployApplication</span><span class="o">(</span><span class="n">WiseApp</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>
<p>With this object, we can:</p>
<ul>
<li><p class="first">Test log event injection:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">StreamWriter</span> <span class="n">streamWriter</span> <span class="o">=</span> <span class="n">appManager</span><span class="o">.</span><span class="na">getStreamWriter</span><span class="o">(</span><span class="s">&quot;logEventStream&quot;</span><span class="o">);</span>
<span class="n">streamWriter</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">&quot;1.202.218.8 - - [12/Apr/2012:02:03:43 -0400] &quot;</span> <span class="o">+</span>
                  <span class="s">&quot;\&quot;GET /product.html HTTP/1.0\&quot; 404 208 \&quot;http://www.example.org\&quot; \&quot;Mozilla/5.0\&quot;&quot;</span><span class="o">);</span>
</pre></div>
</div>
</li>
<li><p class="first">Test the call to a Service endpoint:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">ServiceManager</span> <span class="n">serviceManager</span> <span class="o">=</span> <span class="n">appManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="s">&quot;WiseService&quot;</span><span class="o">);</span>
<span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">serviceManager</span><span class="o">.</span><span class="na">getServiceURL</span><span class="o">(),</span> <span class="s">&quot;ip/1.202.218.8/count&quot;</span><span class="o">);</span>
<span class="n">HttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">HttpRequests</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">());</span>
<span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;3&quot;</span><span class="o">,</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getResponseBody</span><span class="o">()));</span>
</pre></div>
</div>
</li>
<li><p class="first">Start a MapReduce job:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">MapReduceManager</span> <span class="n">mrManager</span> <span class="o">=</span> <span class="n">appManager</span><span class="o">.</span><span class="na">startMapReduce</span><span class="o">(</span><span class="s">&quot;WiseWorkflow_BounceCountsMapReduce&quot;</span><span class="o">);</span>
<span class="n">mrManager</span><span class="o">.</span><span class="na">waitForFinish</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">);</span>
</pre></div>
</div>
</li>
<li><p class="first">Test the output of the MapReduce job:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">DataSetManager</span><span class="o">&lt;</span><span class="n">BounceCountStore</span><span class="o">&gt;</span> <span class="n">dsManager</span> <span class="o">=</span> <span class="n">appManager</span><span class="o">.</span><span class="na">getDataSet</span><span class="o">(</span><span class="s">&quot;bounceCountStore&quot;</span><span class="o">);</span>
<span class="n">BounceCountStore</span> <span class="n">bounceCountStore</span> <span class="o">=</span> <span class="n">dsManager</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="k">new</span> <span class="n">PageBounce</span><span class="o">(</span><span class="s">&quot;/product.html&quot;</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span> <span class="n">bounceCountStore</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;/product.html&quot;</span><span class="o">));</span>
</pre></div>
</div>
</li>
<li><p class="first">Test a SQL query on Datasets:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">Connection</span> <span class="n">exploreConnection</span> <span class="o">=</span> <span class="n">getQueryClient</span><span class="o">();</span>
<span class="n">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span>
  <span class="n">exploreConnection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="s">&quot;SELECT * FROM cdap_user_bouncecountstore ORDER BY uri&quot;</span><span class="o">).</span><span class="na">executeQuery</span><span class="o">();</span>
</pre></div>
</div>
</li>
</ul>
<p>A complete example of the test is included in the downloaded zip.</p>
</div>
<div class="section" id="where-to-go-next">
<h2>Where to Go Next<a class="headerlink" href="#where-to-go-next" title="Permalink to this headline">¶</a></h2>
<p>Now that you&#8217;ve seen a CDAP application, take a look at our additional examples,
located in both the <tt class="docutils literal"><span class="pre">/examples</span></tt> directory of the SDK and <a class="reference internal" href="getstarted.html#examples"><em>also online</em></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!--
  Copyright © 2014 Cask Data, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->

<h3><a href="index.html">Table of Contents</a></h3>
<nav>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="getstarted.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Case Study</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-wise">Running Wise</a></li>
<li class="toctree-l2"><a class="reference internal" href="#overview-of-wise">Overview of Wise</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wise-data-patterns">Wise Data Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-pageviewstore-dataset">The <em>pageViewStore</em> Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-bouncecountstore-dataset">The <em>bounceCountStore</em> Dataset</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ingesting-access-logs-in-wise">Ingesting Access Logs in Wise</a></li>
<li class="toctree-l2"><a class="reference internal" href="#real-time-log-analytics-with-wiseflow">Real-time Log Analytics with WiseFlow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-parser-flowlet">The <em>parser</em> Flowlet</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-pageviewcount-flowlet">The <em>pageViewCount</em> Flowlet</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-the-wiseflow">Building the WiseFlow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#batch-processing-of-logs-with-wiseworkflow">Batch Processing of Logs with WiseWorkflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#plugging-the-stream-to-the-input-of-the-mapreduce-job">Plugging the Stream to the Input of the MapReduce Job</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-to-the-bouncecountstore-dataset-from-the-mapreduce-job">Writing to the <em>bounceCountStore</em> Dataset from the MapReduce Job</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mapreduce-job-structure">MapReduce Job Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scheduling-the-mapreduce-job">Scheduling the MapReduce Job</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#accessing-wise-data-through-wiseservice">Accessing Wise Data through WiseService</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exploring-wise-datasets-through-sql">Exploring Wise Datasets through SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bringing-the-wise-components-together">Bringing the Wise Components Together</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unit-testing-wise">Unit testing Wise</a></li>
<li class="toctree-l2"><a class="reference internal" href="#where-to-go-next">Where to Go Next</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="arch.html">Concepts and Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="apps-packs.html">Apps and Packs</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">APIs and Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="javadocs/index.html">Javadocs</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin.html">Administration and Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="licenses/index.html">Licenses and Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="releasenotes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq/index.html">FAQ</a></li>
</ul>

</nav>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="getstarted.html"
                        title="Previous Chapter">Getting Started with the Cask Data Application Platform</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="arch.html"
                        title="Next Chapter">Cask Data Application Platform Concepts and Architecture</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >Index</a></li>
        <li class="right" >
          <a href="arch.html" title="Cask Data Application Platform Concepts and Architecture"
             >Next</a> |</li>
        <li class="right" >
          <a href="getstarted.html" title="Getting Started with the Cask Data Application Platform"
             >Previous</a> |</li>
        <li><a href="index.html">Cask Data Application Platform 2.5.0 Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014 Cask Data, Inc.
    </div>
  </body>
</html>