<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta name="robots" content="noindex, nofollow">

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Cask Data, Inc." name="author" />
<meta content="Copyright © 2015 Cask Data, Inc." name="copyright" />
<script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55081520-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
    <meta name="git_release" content="3.2.2">
    <meta name="git_hash" content="b267c80c25df10a57efd94370dbfb7a46ca69387">
    <meta name="git_timestamp" content="2015-12-10 18:14:18 -0800">
    <title>Data Analysis with OLAP Cube &mdash; Cask Data Application Platform 3.2.2 Documentation</title>
    
    <link rel="stylesheet" href="../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.2.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <!-- Amazon SQS Page Usage Logging start-->
    <script type="text/javascript" src="https://sdk.amazonaws.com/js/aws-sdk-2.1.35.min.js"></script>
    <script type="text/javascript" src="http://docs.cask.co/resources/scripts/aws-sqs-1.0.0.js"></script>
    <!-- Amazon SQS Page Usage Logging end-->
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 3.2.2 Documentation" href="../index.html" />
    <link rel="up" title="How-To Guides" href="index.html" />
    <link rel="next" title="Creating ETL Applications using CDAP System Artifacts" href="cdap-etl-adapter-guide.html" />
    <link rel="prev" title="Analyzing CDAP Data from BI Tools" href="cdap-bi-guide.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="cdap-etl-adapter-guide.html" title="Creating ETL Applications using CDAP System Artifacts"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="cdap-bi-guide.html" title="Analyzing CDAP Data from BI Tools"
             accesskey="P">Previous</a> |</li>
        
        <script type="text/javascript" src="../_static/version-menu.js"></script>
        <script src="http://docs.cask.co/cdap/json-versions.js"/></script>
        <script>window.setVersion('3.2.2');</script>
       
        <li><a href="../table-of-contents.html">CDAP Examples, Guides, and Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">How-To Guides</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="data-analysis-with-olap-cube">
<span id="cdap-cube-guide"></span><h1>Data Analysis with OLAP Cube<a class="headerlink" href="#data-analysis-with-olap-cube" title="Permalink to this headline">¶</a></h1>
<blockquote class="pull-quote">
<div><strong>Source Code Repository:</strong> Source code (and other resources) for this guide are available at the
<a class="reference external" href="https://github.com/cdap-guides/cdap-cube-guide">CDAP Guides GitHub repository</a>.</div></blockquote>
<p>The <a class="reference external" href="http://cdap.io">Cask Data Application Platform (CDAP)</a> provides a number of
pre-packaged Datasets, which make it easy to store and retrieve data using
best-practices-based implementations of common data access patterns. In this guide, you
will learn how to store multidimensional data points in a Cube dataset
(see <a class="reference external" href="http://en.wikipedia.org/wiki/OLAP_cube">OLAP Cube</a>), and then perform
queries with it. For analysis, we’ll be using an example of processing web logs.</p>
<p>An OLAP (Online Analytical Processing) Cube is multidimensional database or array,
optimized for data warehousing and OLAP applications.</p>
<div class="section" id="what-you-will-build">
<h2>What You Will Build<a class="headerlink" href="#what-you-will-build" title="Permalink to this headline">¶</a></h2>
<p>This guide will take you through building a simple <a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/applications.html">CDAP application</a>
that ingests web logs, aggregates the request counts for different combinations of fields,
and that can then be queried for the volume over a time period. You can then retrieve
insights on the traffic of a web site and the web site’s health. You will:</p>
<ul class="simple">
<li>Use a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/streams.html">Stream</a>
to ingest real-time log data;</li>
<li>Build a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/flows-flowlets/flows.html">Flow</a>
to process log entries as they are received into multidimensional facts;</li>
<li>Use a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/datasets/index.html">Dataset</a>
to store the aggregated numbers; and</li>
<li>Build a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/services.html">Service</a>
to query the aggregated data across multiple dimensions.</li>
</ul>
</div>
<div class="section" id="what-you-will-need">
<h2>What You Will Need<a class="headerlink" href="#what-you-will-need" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 7 or 8</a></li>
<li><a class="reference external" href="http://maven.apache.org/">Apache Maven 3.1+</a></li>
<li><a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/getting-started/standalone/index.html">CDAP SDK</a></li>
</ul>
</div>
<div class="section" id="lets-build-it">
<h2>Let’s Build It!<a class="headerlink" href="#lets-build-it" title="Permalink to this headline">¶</a></h2>
<p>The following sections will guide you through building an application from scratch. If you
are interested in deploying and running the application right away, you can clone its
source code from this GitHub repository. In that case, feel free to skip the next two
sections and jump right to the <a class="reference external" href="#build-and-run-application">Build and Run Application</a>
section.</p>
<div class="section" id="application-design">
<h3>Application Design<a class="headerlink" href="#application-design" title="Permalink to this headline">¶</a></h3>
<p>For this guide we will assume we are processing logs of a web-site that are produced by an
Apache web server. The data could be collected from multiple servers and then sent to our
application over HTTP. There are a number of <a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/ingesting-tools/index.html">tools</a> that
can help you with the ingestion task. We’ll skip over the details of ingesting the data
(as this is <a class="reference external" href="http://docs.cask.io/cdap/current/en/examples-manual/index.html">covered elsewhere</a>) and instead focus on
storing and retrieving the data.</p>
<p>The application consists of these components:</p>
<a class="reference internal image-reference" href="../_images/app-design1.png"><img alt="../_images/app-design1.png" class="align-center" src="../_images/app-design1.png" style="width: 8in;" /></a>
<p>Weblogs are sent to a <code class="docutils literal"><span class="pre">weblogs</span></code> Stream that is consumed by a <code class="docutils literal"><span class="pre">CubeWriterFlow</span></code>.
The <code class="docutils literal"><span class="pre">CubeWriterFlow</span></code> has a single <code class="docutils literal"><span class="pre">CubeWriterFlowlet</span></code> that parses a <code class="docutils literal"><span class="pre">StreamEvent</span></code>’s
body into a <code class="docutils literal"><span class="pre">CubeFact</span></code> and writes it into a <code class="docutils literal"><span class="pre">weblogsCube</span></code> Dataset. The Dataset
is configured to aggregate data for specific combinations of dimensions of a
<code class="docutils literal"><span class="pre">CubeFact</span></code> and provides a querying interface over the stored aggregations.
The application uses a <code class="docutils literal"><span class="pre">CubeService</span></code> to provide an HTTP interface for querying
the <code class="docutils literal"><span class="pre">weblogsCube</span></code>.</p>
</div>
<div class="section" id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<p>The first step is to set up our application structure. We will use a standard
Maven project structure for all of the source code files:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">./pom.xml</span>
<span class="go">./src/main/java/co/cask/cdap/guides/cube/CubeHandler.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/cube/CubeWriterFlow.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/cube/CubeWriterFlowlet.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/cube/WebAnalyticsApp.java</span>
</pre></div>
</div>
<p>The application is identified by the <code class="docutils literal"><span class="pre">WebAnalyticsApp</span></code> class. This class extends
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/reference-manual/javadocs/co/cask/cdap/api/app/AbstractApplication.html">AbstractApplication</a>,
and overrides the <code class="docutils literal"><span class="pre">configure()</span></code> method to define all of the application components:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebAnalyticsApp</span> <span class="kd">extends</span> <span class="n">AbstractApplication</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">APP_NAME</span> <span class="o">=</span> <span class="s">&quot;WebAnalyticsApp&quot;</span><span class="o">;</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">STREAM_NAME</span> <span class="o">=</span> <span class="s">&quot;weblogs&quot;</span><span class="o">;</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CUBE_NAME</span> <span class="o">=</span> <span class="s">&quot;weblogsCube&quot;</span><span class="o">;</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SERVICE_NAME</span> <span class="o">=</span> <span class="s">&quot;CubeService&quot;</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">setName</span><span class="o">(</span><span class="n">APP_NAME</span><span class="o">);</span>

    <span class="n">addStream</span><span class="o">(</span><span class="k">new</span> <span class="n">Stream</span><span class="o">(</span><span class="n">STREAM_NAME</span><span class="o">));</span>

    <span class="c1">// configure the Cube dataset</span>
    <span class="n">DatasetProperties</span> <span class="n">props</span> <span class="o">=</span> <span class="n">DatasetProperties</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;dataset.cube.resolutions&quot;</span><span class="o">,</span> <span class="s">&quot;1,60,3600&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;dataset.cube.aggregation.agg1.dimensions&quot;</span><span class="o">,</span> <span class="s">&quot;response_status&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;dataset.cube.aggregation.agg2.dimensions&quot;</span><span class="o">,</span> <span class="s">&quot;ip,browser&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="n">createDataset</span><span class="o">(</span><span class="n">CUBE_NAME</span><span class="o">,</span> <span class="n">Cube</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>

    <span class="n">addFlow</span><span class="o">(</span><span class="k">new</span> <span class="n">CubeWriterFlow</span><span class="o">());</span>
    <span class="n">addService</span><span class="o">(</span><span class="n">SERVICE_NAME</span><span class="o">,</span> <span class="k">new</span> <span class="n">CubeHandler</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>First, we need a place to receive and process the events. CDAP provides a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/flows-flowlets/index.html">real-time stream processing system</a>
that is a great match for handling event streams. After first setting
the application name, our <code class="docutils literal"><span class="pre">WebAnalyticsApp</span></code> adds a new
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/streams.html">Stream</a>.</p>
<p>Then, the application configures a Cube dataset to compute and store
aggregations for combinations of dimensions. Let’s take a closer
look at the properties that are used to configure the Cube dataset:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;dataset.cube.resolutions&quot;</span><span class="o">,</span> <span class="s">&quot;1,60,3600&quot;</span><span class="o">)</span>
<span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;dataset.cube.aggregation.agg1.dimensions&quot;</span><span class="o">,</span> <span class="s">&quot;response_status&quot;</span><span class="o">)</span>
<span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;dataset.cube.aggregation.agg2.dimensions&quot;</span><span class="o">,</span> <span class="s">&quot;ip,browser&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>A Cube dataset can compute aggregates for multiple time resolutions to provide
a better view of data for both small and large time ranges. For example, you may want to see
data points for each second for the last five minutes, while to build a sensible
chart for a report that covers a week, you may need to see per-hour aggregations.</p>
<p>The code above defines three resolutions: 1 second, 1 minute (60 seconds),
and 1 hour (3600 seconds). When querying the Cube data, you can specify any of
these three depending on your need.</p>
<p>Each aggregation in a Cube is defined by a list of dimensions, which can later be used
for querying. The above code defines two aggregations: “agg1” and agg2”. The first
has only one dimension: <em>response_status</em>. Thus, the Cube will allow queries such as
“number of requests that had a response status 200” or “number of requests for
each response status”.</p>
<p>The second aggregation (“agg2”) defines two dimensions: <em>ip</em> and <em>browser</em>, which allows
querying by ip, by browser, or by using both together, as we shall see below.</p>
<p>After the Cube dataset is configured, the application adds a <code class="docutils literal"><span class="pre">CubeWriterFlow</span></code> to compute
<code class="docutils literal"><span class="pre">CubeFact</span></code>s from the <code class="docutils literal"><span class="pre">StreamEvent</span></code>s and write them to the Cube, and a
<code class="docutils literal"><span class="pre">CubeService</span></code> that has a single handler that provides an HTTP API to query the Cube.</p>
<p>Let’s take a closer look at these two.</p>
<div class="section" id="cubewriterflow">
<h4>CubeWriterFlow<a class="headerlink" href="#cubewriterflow" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CubeWriterFlow</span> <span class="kd">implements</span> <span class="n">Flow</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FLOW_NAME</span> <span class="o">=</span> <span class="s">&quot;CubeWriterFlow&quot;</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">FlowSpecification</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">FlowSpecification</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">with</span><span class="o">()</span>
      <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">FLOW_NAME</span><span class="o">)</span>
      <span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">&quot;Reads logs from a Stream and writes them to a Cube dataset&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">withFlowlets</span><span class="o">()</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;writer&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">CubeWriterFlowlet</span><span class="o">())</span>
      <span class="o">.</span><span class="na">connect</span><span class="o">()</span>
        <span class="o">.</span><span class="na">fromStream</span><span class="o">(</span><span class="n">WebAnalyticsApp</span><span class="o">.</span><span class="na">STREAM_NAME</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;writer&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The Flow configures a single <code class="docutils literal"><span class="pre">CubeWriterFlowlet</span></code> to consume data from a Stream:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CubeWriterFlowlet</span> <span class="kd">extends</span> <span class="n">AbstractFlowlet</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Pattern</span> <span class="n">CLF_PATTERN</span> <span class="o">=</span>
    <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">&quot;^([\\d.]+) (\\S+) (\\S+) \\[([\\w:/]+\\s[+\\-]\\d{4})\\] &quot;</span> <span class="o">+</span>
                      <span class="s">&quot;\&quot;(.+?)\&quot; (\\d{3}) (\\d+) \&quot;([^\&quot;]+)\&quot; \&quot;([^\&quot;]+)\&quot;&quot;</span><span class="o">);</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DateFormat</span> <span class="n">DATE_FORMAT</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span><span class="o">);</span>

  <span class="kd">private</span> <span class="n">Metrics</span> <span class="n">metrics</span><span class="o">;</span>

  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="n">WebAnalyticsApp</span><span class="o">.</span><span class="na">CUBE_NAME</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Cube</span> <span class="n">cube</span><span class="o">;</span>

  <span class="nd">@ProcessInput</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">StreamEvent</span> <span class="n">event</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">logEntryLine</span> <span class="o">=</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>

    <span class="n">Pattern</span> <span class="n">p</span> <span class="o">=</span> <span class="n">CLF_PATTERN</span><span class="o">;</span>
    <span class="n">Matcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">logEntryLine</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">matcher</span><span class="o">.</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">metrics</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">&quot;parse.errors&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// creating CubeFact with timestamp of the log record</span>
    <span class="kt">long</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">DATE_FORMAT</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">4</span><span class="o">)).</span><span class="na">getTime</span><span class="o">();</span>
    <span class="n">CubeFact</span> <span class="n">fact</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CubeFact</span><span class="o">(</span><span class="n">ts</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">);</span>

    <span class="c1">// adding dimensions</span>
    <span class="n">fact</span><span class="o">.</span><span class="na">addDimensionValue</span><span class="o">(</span><span class="s">&quot;ip&quot;</span><span class="o">,</span> <span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="n">fact</span><span class="o">.</span><span class="na">addDimensionValue</span><span class="o">(</span><span class="s">&quot;request&quot;</span><span class="o">,</span> <span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>
    <span class="n">fact</span><span class="o">.</span><span class="na">addDimensionValue</span><span class="o">(</span><span class="s">&quot;response_status&quot;</span><span class="o">,</span> <span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">6</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">8</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;-&quot;</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">fact</span><span class="o">.</span><span class="na">addDimensionValue</span><span class="o">(</span><span class="s">&quot;referrer&quot;</span><span class="o">,</span> <span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">8</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">fact</span><span class="o">.</span><span class="na">addDimensionValue</span><span class="o">(</span><span class="s">&quot;browser&quot;</span><span class="o">,</span> <span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">9</span><span class="o">));</span>

    <span class="c1">// adding measurements</span>
    <span class="n">fact</span><span class="o">.</span><span class="na">addMeasurement</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">,</span> <span class="n">MeasureType</span><span class="o">.</span><span class="na">COUNTER</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="n">Integer</span> <span class="n">bytesSent</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">7</span><span class="o">));</span>
    <span class="n">fact</span><span class="o">.</span><span class="na">addMeasurement</span><span class="o">(</span><span class="s">&quot;bytes.sent&quot;</span><span class="o">,</span> <span class="n">MeasureType</span><span class="o">.</span><span class="na">COUNTER</span><span class="o">,</span> <span class="n">bytesSent</span><span class="o">);</span>
    <span class="n">cube</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fact</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">CubeWriterFlowlet</span></code> uses a Cube dataset that is injected via the <code class="docutils literal"><span class="pre">&#64;UseDataSet</span></code>
annotation with the specified dataset name. It reports on parsing errors by utilizing a
Metrics field injected by the CDAP framework.</p>
<p>The Flowlet process method parses the body of the <code class="docutils literal"><span class="pre">StreamEvent</span></code> that contains a log
entry in a combined log format. Then, it constructs a CubeFact by adding dimensions using the
parsed field values. It adds two measurements to be computed by the Cube in every
aggregation: the “count” for the number of requests, and the “bytes.sent” for the amount
of data sent.</p>
</div>
<div class="section" id="cubeservice">
<h4>CubeService<a class="headerlink" href="#cubeservice" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal"><span class="pre">CubeService</span></code> added to the Application is constructed using a single handler,
<code class="docutils literal"><span class="pre">CubeHandler</span></code>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CubeHandler</span> <span class="kd">extends</span> <span class="n">AbstractCubeHttpHandler</span> <span class="o">{</span>
  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="n">WebAnalyticsApp</span><span class="o">.</span><span class="na">CUBE_NAME</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Cube</span> <span class="n">cube</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="n">Cube</span> <span class="nf">getCube</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">cube</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">AbstractCubeHttpHandler</span></code> that is provided out-of-the-box with CDAP handles basic
Cube methods, such as <em>add</em>, <em>searchDimensionValue</em>, <em>searchMeasure</em>, and <em>query</em>, while the subclass
only needs to return the Cube dataset itself. Below, we will see how to use the HTTP
interface of the Service.</p>
</div>
</div>
</div>
<div class="section" id="build-and-run-application">
<h2>Build and Run Application<a class="headerlink" href="#build-and-run-application" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">WebAnalyticsApp</span></code> application can be built and packaged using the Apache Maven command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> mvn clean package
</pre></div>
</div>
<p>Note that the remaining commands assume that the <code class="docutils literal"><span class="pre">cdap-cli.sh</span></code> script is
available on your PATH. If that is not the case, please add it:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:&lt;CDAP home&gt;/bin
</pre></div>
</div>
<p>If you haven&#8217;t already started a standalone CDAP installation, start it with the command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap.sh start
</pre></div>
</div>
<p>We can then deploy the application to a standalone CDAP installation and start <code class="docutils literal"><span class="pre">CubeWriterFlow</span></code>
and <code class="docutils literal"><span class="pre">CubeService</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh load artifact target/cdap-cube-guide-&lt;version&gt;.jar
<span class="gp">$</span> cdap-cli.sh create app WebAnalyticsApp cdap-cube-guide &lt;version&gt; user
<span class="gp">$</span> cdap-cli.sh start flow WebAnalyticsApp.CubeWriterFlow
<span class="gp">$</span> cdap-cli.sh start service WebAnalyticsApp.CubeService
</pre></div>
</div>
<p>Next, we will send some sample weblogs into the Stream for processing:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh load stream weblogs resources/accesslog.txt
</pre></div>
</div>
<p>As data is being processed, we can start querying it via a RESTful API
provided by the <code class="docutils literal"><span class="pre">CubeService</span></code>. For convenience, we’ve put the queries themselves
into separate JSON files.</p>
<div class="section" id="explore-and-query-cube">
<h3>Explore and Query Cube<a class="headerlink" href="#explore-and-query-cube" title="Permalink to this headline">¶</a></h3>
<p>Many times, users may not know what data a Cube contains and require some
exploration first to construct the queries themselves. Let’s start by searching
for the dimension values that are available in the Cube with this <code class="docutils literal"><span class="pre">CubeExploreQuery</span></code>:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;startTs&quot;</span><span class="p">:</span> <span class="mi">1423370200</span><span class="p">,</span>
    <span class="nt">&quot;endTs&quot;</span><span class="p">:</span>   <span class="mi">1423398198</span><span class="p">,</span>
    <span class="nt">&quot;resolution&quot;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Submit:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -w<span class="s1">&#39;\n&#39;</span> -X POST -d @resources/search-first.json <span class="s1">&#39;http://localhost:10000/v3/namespaces/default/apps/WebAnalyticsApp/services/CubeService/methods/searchDimensionValue&#39;</span>
</pre></div>
</div>
<p>The result will be the dimension values of the first dimensions defined in all aggregations (reformatted
for readability):</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ip&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;69.181.160.120&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ip&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;109.63.206.34&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ip&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;113.72.144.115&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;response_status&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;200&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;response_status&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;404&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>To drill down further into the dimension hierarchy of aggregations, let’s refine the query with a specific dimension value:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;startTs&quot;</span><span class="p">:</span> <span class="mi">1423370200</span><span class="p">,</span>
    <span class="nt">&quot;endTs&quot;</span><span class="p">:</span>   <span class="mi">1423398198</span><span class="p">,</span>
    <span class="nt">&quot;resolution&quot;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ip&quot;</span><span class="p">,</span> <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;69.181.160.120&quot;</span><span class="p">}],</span>
    <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Submit:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -w<span class="s1">&#39;\n&#39;</span> -X POST -d @resources/search-ip.json <span class="s1">&#39;http://localhost:10000/v3/namespaces/default/apps/WebAnalyticsApp/services/CubeService/methods/searchDimensionValue&#39;</span>
</pre></div>
</div>
<p>The result is the dimension values of the next dimension defined in Cube aggregations:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;browser&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.122 Safari/537.36&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The Cube search API allows you to query for available measures via the <code class="docutils literal"><span class="pre">searchMeasure</span></code> endpoint:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -w<span class="s1">&#39;\n&#39;</span> -X POST -d @resources/search-ip.json <span class="s1">&#39;http://localhost:10000/v3/namespaces/default/apps/WebAnalyticsApp/services/CubeService/methods/searchMeasure&#39;</span>
</pre></div>
</div>
<p>The result contains all the measurement names:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span>
    <span class="s2">&quot;bytes.sent&quot;</span><span class="p">,</span>
    <span class="s2">&quot;count&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Now, let’s perform some data queries. Here’s how we can get the timeseries for the
number of bytes sent for a specific source ip, per each browser type:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;aggregation&quot;</span><span class="p">:</span> <span class="s2">&quot;agg2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;resolution&quot;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="nt">&quot;startTs&quot;</span><span class="p">:</span> <span class="mi">1423370200</span><span class="p">,</span>
    <span class="nt">&quot;endTs&quot;</span><span class="p">:</span>   <span class="mi">1423398198</span><span class="p">,</span>
    <span class="nt">&quot;measurements&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;bytes.sent&quot;</span><span class="p">:</span> <span class="s2">&quot;SUM&quot;</span><span class="p">},</span>
    <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;69.181.160.120&quot;</span><span class="p">},</span>
    <span class="nt">&quot;groupByDimensions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;browser&quot;</span><span class="p">],</span>
    <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</pre></div>
</div>
<p>One way of reading the query definition is this analogous SQL command:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span>    <span class="k">sum</span><span class="p">(</span><span class="s1">&#39;bytes.sent&#39;</span><span class="p">)</span>                 <span class="c1">-- measure name and aggregation function</span>
<span class="k">FROM</span>      <span class="n">agg2</span><span class="p">.</span><span class="mi">1</span><span class="n">h_res</span>                       <span class="c1">-- aggregation &amp; resolution</span>
<span class="k">GROUP</span> <span class="k">BY</span>  <span class="n">browser</span>                           <span class="c1">-- groupByDimensions</span>
<span class="k">WHERE</span>     <span class="n">ip</span><span class="o">=</span><span class="s1">&#39;69.181.160.120&#39;</span> <span class="k">AND</span>           <span class="c1">-- dimensionValues</span>
          <span class="n">ts</span><span class="o">&gt;=</span><span class="mi">1423370200</span> <span class="k">AND</span> <span class="n">ts</span><span class="o">&lt;</span><span class="mi">1423398198</span>  <span class="c1">-- startTs &amp; endTs</span>
<span class="k">LIMIT</span>     <span class="mi">1000</span>                              <span class="c1">-- limit</span>
</pre></div>
</div>
<p>Submit:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -w<span class="s1">&#39;\n&#39;</span> -X POST -d @resources/query-ip-browser.json <span class="s1">&#39;http://localhost:10000/v3/namespaces/default/apps/WebAnalyticsApp/services/CubeService/methods/query&#39;</span>
</pre></div>
</div>
<p>The result is a timeseries with one data point (if any are available) per hour:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;measureName&quot;</span><span class="p">:</span> <span class="s2">&quot;bytes.sent&quot;</span><span class="p">,</span>
        <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;browser&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.122 Safari/537.36&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;timeValues&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423371600</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">122240</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423375200</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">122240</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423378800</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">121732</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423382400</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">122240</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423386000</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">121732</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423389600</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">122240</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423393200</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">121732</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423396800</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">47327</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The query below will help to analyse the number of errors (or invalid requests) that the web site handles:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;aggregation&quot;</span><span class="p">:</span> <span class="s2">&quot;agg1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;startTs&quot;</span><span class="p">:</span> <span class="mi">1423370200</span><span class="p">,</span>
    <span class="nt">&quot;endTs&quot;</span><span class="p">:</span>   <span class="mi">1423398198</span><span class="p">,</span>
    <span class="nt">&quot;measurements&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;count&quot;</span><span class="p">:</span> <span class="s2">&quot;SUM&quot;</span><span class="p">},</span>
    <span class="nt">&quot;resolution&quot;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;groupByDimensions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;response_status&quot;</span><span class="p">],</span>
    <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Submit:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -w<span class="s1">&#39;\n&#39;</span> -X POST -d @resources/query-response-status.json <span class="s1">&#39;http://localhost:10000/v3/namespaces/default/apps/WebAnalyticsApp/services/CubeService/methods/query&#39;</span>
</pre></div>
</div>
<p>The result is a multiple timeseries for each response status:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;measureName&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;response_status&quot;</span><span class="p">:</span> <span class="s2">&quot;200&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;timeValues&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423371600</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">969</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423375200</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">360</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423378800</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">409</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423382400</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">468</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423386000</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">465</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423389600</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">468</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423393200</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">471</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423396800</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">186</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;measureName&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;response_status&quot;</span><span class="p">:</span> <span class="s2">&quot;404&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;timeValues&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423375200</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423378800</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423386000</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423393200</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>We can see there are just a few &#8220;404&#8221; responses, which is likely normal for such a
well-managed website(!).</p>
</div>
<div class="section" id="changing-the-cube-configuration">
<h3>Changing the Cube Configuration<a class="headerlink" href="#changing-the-cube-configuration" title="Permalink to this headline">¶</a></h3>
<p>As applications evolve, we may need to change the Cube aggregation configuration to either
support new queries or to optimize existing ones. Let’s see how you can add an
aggregation to an existing Cube.</p>
<p>We’d like the configuration changed to include these properties:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;typeName&quot;</span><span class="p">:</span><span class="s2">&quot;co.cask.cdap.api.dataset.lib.cube.Cube&quot;</span><span class="p">,</span>
    <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;dataset.cube.resolutions&quot;</span><span class="p">:</span><span class="s2">&quot;1,60,3600&quot;</span><span class="p">,</span>
        <span class="nt">&quot;dataset.cube.aggregation.agg1.dimensions&quot;</span><span class="p">:</span><span class="s2">&quot;response_status&quot;</span><span class="p">,</span>
        <span class="nt">&quot;dataset.cube.aggregation.agg2.dimensions&quot;</span><span class="p">:</span><span class="s2">&quot;ip,browser&quot;</span><span class="p">,</span>
        <span class="nt">&quot;dataset.cube.aggregation.agg3.dimensions&quot;</span><span class="p">:</span><span class="s2">&quot;referrer&quot;</span><span class="p">,</span>
        <span class="nt">&quot;dataset.cube.aggregation.agg3.requiredDimensions&quot;</span><span class="p">:</span><span class="s2">&quot;referrer&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We’ve added <em>agg3</em> that computes statistics for referrers. Note the extra property that ends
with <em>requiredDimensions</em>: it specifies to only use this aggregation if the required dimension is present in a CubeFact.
You may have noticed that in <code class="docutils literal"><span class="pre">CubeWriterFlowlet</span></code>, the referrer field may be empty in a log entry.
We don’t want to store extra aggregates in the fact where this is the case.</p>
<p>Let’s update the dataset configuration, and then restart both the Flow and the Service so that the change takes effect:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -w<span class="s1">&#39;\n&#39;</span> -X PUT -d @resources/cube-config.json <span class="s1">&#39;http://localhost:10000/v3/namespaces/default/data/datasets/weblogsCube/properties&#39;</span>
<span class="gp">$</span> cdap-cli.sh stop flow WebAnalyticsApp.CubeWriterFlow
<span class="gp">$</span> cdap-cli.sh start flow WebAnalyticsApp.CubeWriterFlow
<span class="gp">$</span> cdap-cli.sh stop service WebAnalyticsApp.CubeService
<span class="gp">$</span> cdap-cli.sh start service WebAnalyticsApp.CubeService
</pre></div>
</div>
<p>Let’s send additional data to compute new aggregations:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> cdap-cli.sh load stream weblogs resources/accesslog.txt
</pre></div>
</div>
<p>Now, we can retrieve statistics on referrers using the newly-added aggregation:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;aggregation&quot;</span><span class="p">:</span> <span class="s2">&quot;agg3&quot;</span><span class="p">,</span>
    <span class="nt">&quot;startTs&quot;</span><span class="p">:</span> <span class="mi">1423370200</span><span class="p">,</span>
    <span class="nt">&quot;endTs&quot;</span><span class="p">:</span>   <span class="mi">1423398198</span><span class="p">,</span>
    <span class="nt">&quot;measurements&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;count&quot;</span><span class="p">:</span> <span class="s2">&quot;SUM&quot;</span><span class="p">},</span>
    <span class="nt">&quot;resolution&quot;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;referrer&quot;</span><span class="p">:</span> <span class="s2">&quot;http://cdap.io/&quot;</span><span class="p">},</span>
    <span class="nt">&quot;groupByDimensions&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Submit:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -w<span class="s1">&#39;\n&#39;</span> -X POST -d @resources/query-referrer.json <span class="s1">&#39;http://localhost:10000/v3/namespaces/default/apps/WebAnalyticsApp/services/CubeService/methods/query&#39;</span>
</pre></div>
</div>
<p>Result:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;measureName&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="nt">&quot;dimensionValues&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="nt">&quot;timeValues&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423375200</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">3</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1423389600</span><span class="p">,</span>
                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="share-and-discuss">
<h2>Share and Discuss!<a class="headerlink" href="#share-and-discuss" title="Permalink to this headline">¶</a></h2>
<p>Have a question? Discuss at the <a class="reference external" href="https://groups.google.com/forum/#!forum/cdap-user">CDAP User Mailing List</a>.</p>
</div>
<div class="section" id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h2>
<p>Copyright © 2015 Cask Data, Inc.</p>
<p>Licensed under the Apache License, Version 2.0 (the &#8220;License&#8221;); you may
not use this file except in compliance with the License. You may obtain
a copy of the License at</p>
<p><a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#8220;AS IS&#8221; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="manuals links">
    <h3><a href="../table-of-contents/../../index.html"
        rel="nofollow">CDAP Documentation v3.2.2</a></h3>
    <ul class="this-page-menu">
      <li><div class=""></div><a href="../table-of-contents/../../index.html"
            rel="nofollow">Overview</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../introduction/index.html"
            rel="nofollow">Introduction to CDAP</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../developers-manual/index.html"
            rel="nofollow">Developers’ Manual</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../included-applications/index.html"
            rel="nofollow">Included Applications</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../admin-manual/index.html"
            rel="nofollow">Administration Manual</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../integrations/index.html"
            rel="nofollow">Integrations</a></li>
            
      <li><div class=""></div><b><a href="../table-of-contents/../../examples-manual/index.html"
            rel="nofollow">Examples, Guides, and Tutorials</a></b></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/index.html"
            rel="nofollow">Reference Manual</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../faqs/index.html"
            rel="nofollow">FAQs</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/release-notes.html"
            rel="nofollow">Release Notes</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/glossary.html"
            rel="nofollow">Glossary</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../search.html"
            rel="nofollow">Search</a></li>
    </ul>
   </div><!--
  Copyright © 2014-2015 Cask Data, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->


    
<h3 class="pagenavtitle"><a href="../table-of-contents.html">Examples, Guides, and Tutorials:<br> Table&nbsp;of&nbsp;Contents</a></h3>
<nav class="pagenav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How-To Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cdap-bi-guide.html">Analyzing CDAP Data from BI Tools</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Data Analysis with OLAP Cube</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-you-will-build">What You Will Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-you-will-need">What You Will Need</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lets-build-it">Let’s Build It!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-and-run-application">Build and Run Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#share-and-discuss">Share and Discuss!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cdap-etl-adapter-guide.html">Creating ETL Applications using CDAP System Artifacts</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-flow-guide.html">Real-Time Data Processing with a Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-flume-guide.html">Ingesting Data into CDAP using Apache Flume</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-kafka-ingest-guide.html">Consuming Data from Kafka</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-mapreduce-guide.html">Batch Data Processing with CDAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-spark-guide.html">Iterative Data Processing with Apache Spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-timeseries-guide.html">Storing Timeseries Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-twitter-ingest-guide.html">Consuming Twitter Data in Real Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-workflow-guide.html">Batch Data Processing with CDAP using Workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apps-packs.html">Apps and Packs</a></li>
</ul>
 
</nav>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="cdap-bi-guide.html"
                        title="Previous Chapter">Analyzing CDAP Data from BI Tools</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="cdap-etl-adapter-guide.html"
                        title="Next Chapter">Creating ETL Applications using CDAP System Artifacts</a></p>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/cdap/3.2.2/cdap-docs-3.2.2-web.zip"
            rel="nofollow">Zip Archive of CDAP Documentation</a></li>
    </ul>
   </div>
  
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div role="note" aria-label="other links">
    <h3><a href="http://docs.cask.co/" target="_blank">Documentation</a></h3>
    <ul class="this-page-menu">
        <li><a href="http://docs.cask.co/cdap/index.html" target="_blank">CDAP</a></li>
        <li><a href="http://docs.cask.co/coopr/index.html" target="_blank">Coopr</a></li>
        <li><a href="http://docs.cask.co/tephra/index.html" target="_blank">Tephra</em></a></li>
        <li><a href="http://docs.cask.co/tigon/index.html" target="_blank">Tigon</a></li>
    </ul>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>
  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Analyzing CDAP Data from BI Tools" href="cdap-bi-guide.html" />Analyzing CDAP Data from BI Tools</a>&nbsp;&nbsp;
    
    </th>
    <th class="tg-s6z2">
        Copyright &copy; 2014-2015 Cask Data, Inc.
    
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="Creating ETL Applications using CDAP System Artifacts" href="cdap-etl-adapter-guide.html" />Creating ETL Applications using CDAP System Artifacts</a>
    
    </th>
  </tr>
</table>

    </div>
  </body>
</html>