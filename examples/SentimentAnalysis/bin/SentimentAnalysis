#!/usr/bin/env bash

bin=`dirname "${BASH_SOURCE-$0}"`
bin=`cd "$bin"; pwd`
script=`basename $0`

source $bin/../../common.sh

jar="$bin/../target/SentimentAnalysis-1.0.0.jar"

PID_FILE="$bin/.sentiment-analysis.pid"
STREAM_URL="http://$gateway/v2/streams/sentence"

start_node() {
  if [ ! -f $PID_FILE ]; then
    pushd webapp 2>&1 >/dev/null  
    /usr/bin/env node server.js 2>/dev/null >/dev/null </dev/null &
    echo $! > $PID_FILE
    popd 2>&1 >/dev/null
  fi
}

stop_node() {
  if [ -f $PID_FILE ]; then
    PID=`cat $PID_FILE`
    if [ x"$PID" != "x" ]; then
      kill -9 $PID 2>/dev/null >/dev/null
      rm -f $PID_FILE
    fi
  fi
}

start() {
  # Start flow and procedure
  echo "Starting sentiment analysis application ..."
  curl -s -X POST http://$gateway/v2/apps/sentiment/flows/analysis/start 2>/dev/null
  curl -s -X POST http://$gateway/v2/apps/sentiment/procedures/sentiment-query/start 2>/dev/null

  # Start node.
  start_node; sleep 3

  # Send events
  curl -s -d "Building big data apps is hard" $STREAM_URL
  curl -s -d "Continuuity Reactor is awesome" $STREAM_URL
  curl -s -d "I love hbase" $STREAM_URL
  curl -s -d "I have hard time building apps on hadoop" $STREAM_URL
  curl -s -d "Continuuity Reactor makes it easy, love it" $STREAM_URL
  curl -s -d "Reactor 2.0.0 is awesome" $STREAM_URL
  curl -s -d "Hadoop is a big data platform" $STREAM_URL
  curl -s -d "Continuuity Weave is awesome" $STREAM_URL
  curl -s -d "Hadoop is hard" $STREAM_URL

  name=`echo $gateway | awk -F":" '{ print $1 }'`
  open http://$name:8000
}

stop() {
  # Stop flow and procedure
  curl -s -X POST http://$gateway/v2/apps/sentiment/flows/analysis/stop 2>/dev/null
  curl -s -X POST http://$gateway/v2/apps/sentiment/procedures/sentiment-query/stop 2>/dev/null

  # Stop node
  stop_node
}

if [ "x$action" != "xdeploy" ] && [ "x$action" != "xstart" ] && [ "x$action" != "xstop" ]; then
  usage
  exit 1
fi

if [ "x$action" == "xdeploy" ]; then
  stop
fi


$action
